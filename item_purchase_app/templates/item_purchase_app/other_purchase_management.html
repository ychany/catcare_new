{% extends 'common_app/base.html' %}
{% load static humanize %}

{% block title %}ë¹„ìš©ê´€ë¦¬ - ëƒ¥ì´ ì§‘ì‚¬{% endblock %}

{% block content %}
<div class="weight-header">
  <div class="weight-nav">
    <div class="nav-left">
      <button class="back-btn" onclick="history.back()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <span class="weight-title">
        <i class="fas fa-wallet"></i>
        ë¹„ìš©ê´€ë¦¬
      </span>
    </div>
  </div>
</div>
<style>
.weight-header {
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
  padding: 24px 0 16px 0;
}
.weight-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  max-width: 1200px;
  margin: 0 auto;
  margin-bottom: 0;
  padding: 0 20px;
}
.nav-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.back-btn {
  background: none;
  border: none;
  font-size: 24px;
  color: #222f3e;
  cursor: pointer;
  padding: 4px;
  border-radius: 8px;
  transition: background-color 0.2s;
}
.back-btn:hover {
  background: #f3f4f6;
}
.weight-title {
  font-size: 24px;
  font-weight: 700;
  color: #222f3e;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.weight-title i {
  color: #222f3e;
  background: #f3f4f6;
  border-radius: 8px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}
</style>

    <!-- ëŒ€ì‹œë³´ë“œ ì¹´ë“œë“¤ -->
    <div class="dashboard-section">
        <div class="container">
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-icon">
                    <i class="fas fa-wallet"></i>
            </div>
                <div class="stat-info">
                    <div class="stat-number">{{ total_price|floatformat:0|intcomma }}ì›</div>
                    <div class="stat-label">ì´ë²ˆ ë‹¬ ì´ ì§€ì¶œ</div>
                </div>
                <div class="stat-trend">
                    <i class="fas fa-arrow-up"></i>
                    <span>ì§€ë‚œë‹¬ ëŒ€ë¹„ +12%</span>
        </div>
    </div>

            <div class="stat-card average">
                <div class="stat-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-number">{{ average_daily|floatformat:0|intcomma }}ì›</div>
                    <div class="stat-label">ì¼ í‰ê·  ì§€ì¶œ</div>
                </div>
                <div class="stat-trend">
                    <i class="fas fa-minus"></i>
                    <span>í‰ì†Œì™€ ë¹„ìŠ·</span>
        </div>
    </div>

            <div class="stat-card count">
                <div class="stat-icon">
                    <i class="fas fa-shopping-bag"></i>
            </div>
                <div class="stat-info">
                    <div class="stat-number">{{ purchases.count }}ê±´</div>
                    <div class="stat-label">ì´ë²ˆ ë‹¬ êµ¬ë§¤</div>
                        </div>
                <div class="stat-trend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+3ê±´</span>
                        </div>
                        </div>
            
            <div class="stat-card largest">
                <div class="stat-icon">
                    <i class="fas fa-crown"></i>
                        </div>
                <div class="stat-info">
                    <div class="stat-number">{{ largest_expense|floatformat:0|intcomma }}ì›</div>
                    <div class="stat-label">ìµœëŒ€ ì§€ì¶œ</div>
                    </div>
                <div class="stat-trend">
                    <i class="fas fa-tag"></i>
                    <span>{{ largest_category }}</span>
            </div>
        </div>
    </div>

        <!-- ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ì°¨íŠ¸ -->
        <div class="chart-section">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</h3>
                    <div class="chart-period">
                        <select class="period-select" id="periodSelect">
                            <option value="month">ì´ë²ˆ ë‹¬</option>
                            <option value="quarter">ìµœê·¼ 3ê°œì›”</option>
                            <option value="year">ì˜¬í•´</option>
                        </select>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            </div>
        </div>
        </div>

    <!-- í•„í„° ë° ê²€ìƒ‰ -->
    <div class="filter-section">
        <div class="container">
        <div class="filter-card">
            <div class="filter-group">
                <label class="filter-label">ê¸°ê°„</label>
                <input type="month" class="filter-input" id="monthFilter" value="{{ current_month }}">
                        </div>
            <div class="filter-group">
                <label class="filter-label">ê³ ì–‘ì´</label>
                <select class="filter-input" id="petFilter">
                    <option value="">ì „ì²´ ê³ ì–‘ì´</option>
                    {% for pet in pets %}
                    <option value="{{ pet.id }}" {% if selected_pet_id == pet.id|stringformat:"i" %}selected{% endif %}>{{ pet.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">ì¹´í…Œê³ ë¦¬</label>
                <select class="filter-input" id="categoryFilter">
                    <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                    <option value="ì¥ë‚œê°" {% if selected_category == "ì¥ë‚œê°" %}selected{% endif %}>ğŸ§¸ ì¥ë‚œê°</option>
                    <option value="ê°„ì‹" {% if selected_category == "ê°„ì‹" %}selected{% endif %}>ğŸ– ê°„ì‹</option>
                    <option value="ìš©í’ˆ" {% if selected_category == "ìš©í’ˆ" %}selected{% endif %}>ğŸ  ìš©í’ˆ</option>
                    <option value="ì˜ë£Œ" {% if selected_category == "ì˜ë£Œ" %}selected{% endif %}>ğŸ¥ ì˜ë£Œ</option>
                    <option value="ë¯¸ìš©" {% if selected_category == "ë¯¸ìš©" %}selected{% endif %}>âœ‚ï¸ ë¯¸ìš©</option>
                    <option value="ê¸°íƒ€" {% if selected_category == "ê¸°íƒ€" %}selected{% endif %}>ğŸ“¦ ê¸°íƒ€</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">ê²€ìƒ‰</label>
                <div class="search-input-wrapper">
                    <input type="text" class="filter-input" id="searchFilter" placeholder="ìƒí’ˆëª… ê²€ìƒ‰..." value="{{ search }}">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            <div class="filter-group">
                <label class="filter-label">&nbsp;</label>
                <button type="button" class="btn btn-primary btn-search" id="searchBtn">
                    <i class="fas fa-search"></i>
                    ì¡°íšŒ
                </button>
            </div>
                        </div>
                    </div>
        </div>
    </div>
                    
    <!-- ì§€ì¶œ ë‚´ì—­ -->
    <div class="expenses-section">
        <div class="container">
        <div class="section-header">
            <h2 class="section-title">ì§€ì¶œ ë‚´ì—­</h2>
            <div class="view-controls">
                <button class="view-control active" data-view="list">
                    <i class="fas fa-list"></i>
                    ëª©ë¡
                </button>
                <button class="view-control" data-view="grid">
                    <i class="fas fa-th-large"></i>
                    ì¹´ë“œ
                </button>
                <button class="view-control" data-view="timeline">
                    <i class="fas fa-chart-line"></i>
                    íƒ€ì„ë¼ì¸
                </button>
            </div>
            <button class="btn btn-primary btn-sm" id="addExpenseBtn" style="margin-left:12px;">
                <i class="fas fa-plus"></i> ì§€ì¶œ ì¶”ê°€
            </button>
        </div>

        <!-- ëª©ë¡ ë·° -->
        <div class="list-view" id="listView">
            <div class="expense-table">
                <div class="table-header">
                    <div class="col-date">ë‚ ì§œ</div>
                    <div class="col-category">ì¹´í…Œê³ ë¦¬</div>
                    <div class="col-product">ìƒí’ˆëª…</div>
                    <div class="col-pet">ê³ ì–‘ì´</div>
                    <div class="col-price">ê¸ˆì•¡</div>
                    <div class="col-rating">ë§Œì¡±ë„</div>
                    <div class="col-actions">ì‘ì—…</div>
                </div>
                <div class="table-body" id="expenseTableBody">
                    {% for purchase in purchases %}
                    <div class="table-row" data-category="{{ purchase.type }}" data-pet="{{ purchase.cat.id }}">
                        <div class="col-date">{{ purchase.purchase_date|date:"m.d" }}</div>
                        <div class="col-category">
                            <span class="category-badge {{ purchase.type }}">{{ purchase.type }}</span>
                        </div>
                        <div class="col-product">{{ purchase.product_name }}</div>
                        <div class="col-pet">{{ purchase.cat.name }}</div>
                        <div class="col-price">{{ purchase.price|floatformat:0|intcomma }}ì›</div>
                        <div class="col-rating">
                        {% if purchase.rating > 0 %}
                            <div class="rating-stars">
                                {% for i in "12345" %}
                                    <i class="fas fa-star {% if forloop.counter <= purchase.rating %}active{% endif %}"></i>
                                {% endfor %}
                            </div>
                                    {% else %}
                            <span class="no-rating">-</span>
                                    {% endif %}
                        </div>
                        <div class="col-actions">
                            <button class="btn btn-ghost btn-sm" onclick="editExpense({{ purchase.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-ghost btn-sm text-danger" onclick="deleteExpense({{ purchase.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <h3>ì§€ì¶œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>ì²« ë²ˆì§¸ ì§€ì¶œì„ ê¸°ë¡í•´ë³´ì„¸ìš”!</p>
                        <button class="btn btn-primary" id="addFirstExpenseBtn">
                            <i class="fas fa-plus"></i>
                            ì§€ì¶œ ì¶”ê°€í•˜ê¸°
                        </button>
                    </div>
                                {% endfor %}
                            </div>
                        </div>
        </div>

        <!-- ì¹´ë“œ ë·° -->
        <div class="grid-view" id="gridView" style="display: none;">
            <div class="expense-grid">
                {% for purchase in purchases %}
                <div class="expense-card" data-category="{{ purchase.type }}" data-pet="{{ purchase.cat.id }}">
                    <div class="expense-header">
                        <span class="expense-date">{{ purchase.purchase_date|date:"Y.m.d" }}</span>
                        <span class="category-badge {{ purchase.type }}">{{ purchase.type }}</span>
                    </div>
                    <div class="expense-content">
                        <h4 class="expense-title">{{ purchase.product_name }}</h4>
                        <div class="expense-meta">
                            <span class="expense-pet">
                                <i class="fas fa-cat"></i>
                                {{ purchase.cat.name }}
                            </span>
                            <span class="expense-price">{{ purchase.price|floatformat:0|intcomma }}ì›</span>
                        </div>
                        {% if purchase.rating > 0 %}
                        <div class="expense-rating">
                            {% for i in "12345" %}
                                <i class="fas fa-star {% if forloop.counter <= purchase.rating %}active{% endif %}"></i>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="expense-actions">
                        {% if purchase.purchase_link %}
                        <a href="{{ purchase.purchase_link }}" target="_blank" class="btn btn-ghost btn-sm">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                        {% endif %}
                        <button class="btn btn-ghost btn-sm" onclick="editExpense({{ purchase.id }})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-ghost btn-sm text-danger" onclick="deleteExpense({{ purchase.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- íƒ€ì„ë¼ì¸ ë·° -->
        <div class="timeline-view" id="timelineView" style="display: none;">
            <div class="timeline">
                {% regroup purchases by purchase_date.date as expenses_by_date %}
                {% for date_group in expenses_by_date %}
                <div class="timeline-date">
                    <h4>{{ date_group.grouper|date:"Yë…„ mì›” dì¼" }}</h4>
                    <div class="date-total">
                        ì´ ì§€ì¶œ
                    </div>
                </div>
                <div class="timeline-items">
                    {% for expense in date_group.list %}
                    <div class="timeline-item">
                        <div class="timeline-marker {{ expense.type }}"></div>
                        <div class="timeline-content">
                            <div class="timeline-title">{{ expense.product_name }}</div>
                            <div class="timeline-meta">
                                <span class="timeline-price">{{ expense.price|floatformat:0|intcomma }}ì›</span>
                                <span class="timeline-category">{{ expense.type }}</span>
                                <span class="timeline-pet">{{ expense.cat.name }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        </div>
    </div>
</div>

<!-- ì§€ì¶œ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal" id="expenseModal">
    <div class="modal-dialog">
        <div class="modal-content">
                <div class="modal-header">
                <h3 class="modal-title">ì§€ì¶œ ê¸°ë¡ ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeExpenseModal()">
                    <i class="fas fa-times"></i>
                </button>
                </div>
                
            <form id="expenseForm">
                    {% csrf_token %}
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ê³ ì–‘ì´</label>
                            <select class="form-input" name="pet" required>
                                <option value="">ê³ ì–‘ì´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                {% for pet in pets %}
                                <option value="{{ pet.id }}">{{ pet.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">êµ¬ë§¤ì¼</label>
                            <input type="date" class="form-input" name="purchase_date" required>
                        </div>
                        </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                            <select class="form-input" name="type" required>
                                <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì¥ë‚œê°">ğŸ§¸ ì¥ë‚œê°</option>
                                <option value="ê°„ì‹">ğŸ– ê°„ì‹</option>
                                <option value="ìš©í’ˆ">ğŸ  ìš©í’ˆ</option>
                                <option value="ì˜ë£Œ">ğŸ¥ ì˜ë£Œ</option>
                                <option value="ë¯¸ìš©">âœ‚ï¸ ë¯¸ìš©</option>
                                <option value="ê¸°íƒ€">ğŸ“¦ ê¸°íƒ€</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ê¸ˆì•¡</label>
                            <input type="number" class="form-input" name="price" placeholder="0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ìƒí’ˆëª…</label>
                        <input type="text" class="form-input" name="product_name" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">êµ¬ë§¤ì²˜ ë§í¬</label>
                        <input type="url" class="form-input" name="purchase_link" placeholder="https://...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ë§Œì¡±ë„</label>
                        <div class="rating-input">
                            {% for i in "12345" %}
                            <button type="button" class="rating-star" data-rating="{{ i }}">
                                <i class="fas fa-star"></i>
                            </button>
                            {% endfor %}
                            <input type="hidden" name="rating" value="0">
                            </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ë©”ëª¨</label>
                        <textarea class="form-input" name="memo" rows="3" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeExpenseModal()">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ì €ì¥í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* í˜ì´ì§€ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
.expense-management {
    max-width: 1200px;
    margin: 0 auto;
}

/* ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

/* í˜ì´ì§€ í—¤ë” */
.page-header {
    margin-bottom: 48px;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-xl);
    }

.page-title {
    font-size: 32px;
        font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--spacing-sm);
}

.page-description {
    font-size: 16px;
    color: var(--text-secondary);
    margin: 0;
}

.header-actions {
    display: flex;
    gap: var(--spacing-md);
    flex-shrink: 0;
}

/* ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ */
.dashboard-section {
    margin-bottom: var(--spacing-4xl);
}

/* í†µê³„ ì¹´ë“œ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-3xl);
    }

    .stat-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--primary-color);
}

.stat-card.total::before { background: linear-gradient(135deg, #667eea, #764ba2); }
.stat-card.average::before { background: linear-gradient(135deg, #f093fb, #f5576c); }
.stat-card.count::before { background: linear-gradient(135deg, #4facfe, #00f2fe); }
.stat-card.largest::before { background: linear-gradient(135deg, #43e97b, #38f9d7); }

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
    color: var(--white);
    font-size: 20px;
    margin-bottom: var(--spacing-lg);
}

.stat-card.total .stat-icon { background: linear-gradient(135deg, #667eea, #764ba2); }
.stat-card.average .stat-icon { background: linear-gradient(135deg, #f093fb, #f5576c); }
.stat-card.count .stat-icon { background: linear-gradient(135deg, #4facfe, #00f2fe); }
.stat-card.largest .stat-icon { background: linear-gradient(135deg, #43e97b, #38f9d7); }

.stat-number {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
}

.stat-label {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-md);
}

.stat-trend {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 12px;
    color: var(--text-muted);
}

/* ì°¨íŠ¸ ì„¹ì…˜ */
.chart-section {
    margin-bottom: var(--spacing-3xl);
}

.chart-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
}

.chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    margin-bottom: var(--spacing-xl);
    }

.chart-title {
    font-size: 20px;
        font-weight: 600;
    color: var(--text-primary);
        margin: 0;
}

.period-select {
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 14px;
}

.chart-content {
    height: 300px;
}

/* í•„í„° ì„¹ì…˜ */
.filter-section {
    margin-bottom: var(--spacing-3xl);
}

.filter-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    display: flex;
    gap: var(--spacing-3xl);
        align-items: end;
    }

.filter-group {
        display: flex;
        flex-direction: column;
    gap: var(--spacing-sm);
    }

.filter-label {
        font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
    white-space: nowrap;
}

.filter-input {
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 14px;
    min-width: 150px;
}

.search-input-wrapper {
    position: relative;
}

.search-icon {
    position: absolute;
    right: var(--spacing-md);
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
}

.btn-search {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    min-width: 100px;
    justify-content: center;
}

.btn-search:hover {
    background: #e55a2b;
    transform: translateY(-1px);
}

/* ì§€ì¶œ ì„¹ì…˜ */
.expenses-section {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
        overflow: hidden;
    }

    .section-header {
    padding: var(--spacing-xl);
    border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-title {
    font-size: 20px;
        font-weight: 600;
    color: var(--text-primary);
        margin: 0;
}

.view-controls {
    display: flex;
    gap: var(--spacing-xs);
}

.view-control {
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
        display: flex;
        align-items: center;
    gap: var(--spacing-xs);
}

.view-control:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.view-control.active {
    background: var(--primary-color);
    color: var(--white);
    border-color: var(--primary-color);
}

/* í…Œì´ë¸” ë·° */
.expense-table {
    width: 100%;
}

.table-header, .table-row {
        display: grid;
    grid-template-columns: 80px 120px 2fr 120px 120px 100px 80px;
    gap: var(--spacing-lg);
    padding: var(--spacing-lg) var(--spacing-xl);
    align-items: center;
}

.table-header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-light);
    font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
}

.table-row {
    border-bottom: 1px solid var(--border-light);
    transition: all 0.2s ease;
}

.table-row:hover {
    background: var(--bg-secondary);
}

.category-badge {
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-full);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.category-badge.ì¥ë‚œê° { background: rgba(99, 102, 241, 0.1); color: #6366f1; }
.category-badge.ê°„ì‹ { background: rgba(245, 101, 101, 0.1); color: #f56565; }
.category-badge.ìš©í’ˆ { background: rgba(52, 211, 153, 0.1); color: #34d399; }
.category-badge.ì˜ë£Œ { background: rgba(251, 146, 60, 0.1); color: #fb923c; }
.category-badge.ë¯¸ìš© { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
.category-badge.ê¸°íƒ€ { background: rgba(107, 114, 128, 0.1); color: #6b7280; }

.rating-stars {
        display: flex;
    gap: 2px;
}

.rating-stars .fas.fa-star {
    color: var(--border-medium);
    font-size: 12px;
}

.rating-stars .fas.fa-star.active {
    color: #fbbf24;
}

.no-rating {
    color: var(--text-muted);
}

/* ì¹´ë“œ ë·° */
.expense-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing-lg);
    padding: var(--spacing-xl);
}

.expense-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    transition: all 0.3s ease;
}

.expense-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.expense-header {
        display: flex;
    justify-content: space-between;
        align-items: center;
    margin-bottom: var(--spacing-md);
}

.expense-date {
    font-size: 13px;
    color: var(--text-secondary);
}

.expense-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--spacing-md);
}

.expense-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.expense-pet {
        display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: var(--text-secondary);
    font-size: 14px;
}

.expense-price {
    font-weight: 600;
    color: var(--primary-color);
}

.expense-rating {
        display: flex;
    gap: 2px;
    margin-bottom: var(--spacing-md);
}

.expense-actions {
        display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
}

/* íƒ€ì„ë¼ì¸ ë·° */
.timeline {
    padding: var(--spacing-xl);
}

.timeline-date {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg) 0;
    border-bottom: 2px solid var(--border-light);
    margin-bottom: var(--spacing-lg);
}

.timeline-date h4 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.date-total {
    font-weight: 600;
    color: var(--primary-color);
}

.timeline-items {
    margin-bottom: var(--spacing-3xl);
}

.timeline-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-lg);
    padding: var(--spacing-md) 0;
    border-left: 2px solid var(--border-light);
    padding-left: var(--spacing-xl);
    position: relative;
}

.timeline-marker {
    position: absolute;
    left: -6px;
    width: 10px;
    height: 10px;
    border-radius: var(--radius-full);
    background: var(--primary-color);
}

.timeline-content {
    flex: 1;
}

.timeline-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
}

.timeline-meta {
    display: flex;
    gap: var(--spacing-lg);
    font-size: 13px;
    color: var(--text-secondary);
}

.timeline-price {
        font-weight: 600;
    color: var(--primary-color);
}

/* ë¹ˆ ìƒíƒœ */
.empty-state {
    text-align: center;
    padding: var(--spacing-6xl) var(--spacing-3xl);
    grid-column: 1 / -1;
}

.empty-icon {
    width: 80px;
    height: 80px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--spacing-xl);
    color: var(--text-muted);
    font-size: 32px;
}

.empty-state h3 {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--spacing-md);
}

.empty-state p {
    color: var(--text-secondary);
    margin-bottom: var(--spacing-xl);
}

/* ëª¨ë‹¬ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    padding: var(--spacing-xl);
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-dialog {
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-content {
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
}

.modal-header {
    padding: var(--spacing-xl);
    border-bottom: 1px solid var(--border-light);
        display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.modal-close {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
        cursor: pointer;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.modal-body {
    padding: var(--spacing-xl);
    }

    .modal-footer {
    padding: var(--spacing-xl);
    border-top: 1px solid var(--border-light);
        display: flex;
    gap: var(--spacing-md);
        justify-content: flex-end;
    }

/* í‰ì  ì…ë ¥ */
.rating-input {
        display: flex;
    gap: var(--spacing-sm);
}

.rating-star {
    background: none;
    border: none;
    color: var(--border-medium);
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.rating-star:hover,
.rating-star.active {
    color: #fbbf24;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
        .header-content {
            flex-direction: column;
        align-items: stretch;
    }

    .filter-card {
            flex-direction: column;
            align-items: stretch;
        gap: var(--spacing-lg);
        }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        }

    .table-header, .table-row {
            grid-template-columns: 1fr;
        text-align: center;
    }

    .table-header {
        display: none;
    }

    .table-row {
        display: flex;
            flex-direction: column;
        gap: var(--spacing-sm);
        padding: var(--spacing-lg);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-sm);
    }

    .expense-grid {
        grid-template-columns: 1fr;
    }

    .form-row {
        grid-template-columns: 1fr;
    }
}

.text-danger {
    color: var(--danger-color) !important;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
window.categoryLabels = {{ category_labels|safe }};
window.categoryTotals = {{ category_totals|safe }};
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ì°¨íŠ¸ ì´ˆê¸°í™”
    initializeChart();
    
    // ë·° ì»¨íŠ¸ë¡¤
    const viewControls = document.querySelectorAll('.view-control');
    viewControls.forEach(control => {
        control.addEventListener('click', function() {
            viewControls.forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            const view = this.dataset.view;
            document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('gridView').style.display = view === 'grid' ? 'block' : 'none';
            document.getElementById('timelineView').style.display = view === 'timeline' ? 'block' : 'none';
        });
    });
    
    // í•„í„° ê¸°ëŠ¥
    const filters = document.querySelectorAll('.filter-input');
    filters.forEach(filter => {
        filter.addEventListener('change', applyFilters);
    });
    
    document.getElementById('searchFilter').addEventListener('input', debounce(applyFilters, 300));
    
    // ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('searchBtn').addEventListener('click', performSearch);
    
    // ê²€ìƒ‰ ì…ë ¥ì—ì„œ ì—”í„° í‚¤ ì´ë²¤íŠ¸
    document.getElementById('searchFilter').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // ì§€ì¶œ ì¶”ê°€ ë²„íŠ¼ë“¤
    document.getElementById('addExpenseBtn').addEventListener('click', openExpenseModal);
    document.getElementById('addFirstExpenseBtn')?.addEventListener('click', openExpenseModal);
    
    // ë³„ì  ê¸°ëŠ¥
    const ratingStars = document.querySelectorAll('.rating-star');
    const ratingInput = document.querySelector('input[name="rating"]');
    
    ratingStars.forEach(star => {
            star.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            ratingInput.value = rating;
            
            ratingStars.forEach((s, index) => {
                if (index < rating) {
                    s.classList.add('active');
                } else {
                    s.classList.remove('active');
                }
            });
                });
            });
            
    // í¼ ì œì¶œ ì²˜ë¦¬
    document.getElementById('expenseForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveExpense();
            });
        });

// ì°¨íŠ¸ ì´ˆê¸°í™”
function initializeChart() {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: window.categoryLabels,
            datasets: [{
                data: window.categoryTotals,
                backgroundColor: [
                    '#6366f1','#f56565','#34d399','#fb923c','#a855f7','#6b7280'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
}

// ì„œë²„ ì‚¬ì´ë“œ ê²€ìƒ‰/í•„í„°ë§ ìˆ˜í–‰
function performSearch() {
    const monthFilter = document.getElementById('monthFilter').value;
    const petFilter = document.getElementById('petFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const searchFilter = document.getElementById('searchFilter').value;
    
    // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
    const params = new URLSearchParams();
    
    if (monthFilter) params.set('month', monthFilter);
    if (petFilter) params.set('pet', petFilter);
    if (categoryFilter) params.set('category', categoryFilter);
    if (searchFilter) params.set('search', searchFilter);
    
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì„œë²„ì—ì„œ í•„í„°ë§ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const currentUrl = window.location.pathname;
    const newUrl = params.toString() ? `${currentUrl}?${params.toString()}` : currentUrl;
    
    window.location.href = newUrl;
}

// í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„° ì ìš© (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
function applyFilters() {
    const monthFilter = document.getElementById('monthFilter').value;
    const petFilter = document.getElementById('petFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('.table-row');
    const cards = document.querySelectorAll('.expense-card');
    
    [...rows, ...cards].forEach(item => {
        const category = item.dataset.category;
        const pet = item.dataset.pet;
        const productName = item.querySelector('.col-product, .expense-title')?.textContent.toLowerCase() || '';
        
        let show = true;
        
        if (petFilter && pet !== petFilter) show = false;
        if (categoryFilter && category !== categoryFilter) show = false;
        if (searchFilter && !productName.includes(searchFilter)) show = false;
        
        item.style.display = show ? (item.classList.contains('table-row') ? 'grid' : 'block') : 'none';
    });
}

// ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
function openExpenseModal() {
    document.getElementById('expenseModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
    const today = new Date().toISOString().split('T')[0];
    document.querySelector('input[name="purchase_date"]').value = today;
}

let editingExpenseId = null;

function editExpense(expenseId) {
    fetch(`/items/api/otherpurchase/${expenseId}/`)
        .then(response => response.json())
        .then(data => {
            editingExpenseId = expenseId;
            openExpenseModal(); // ëª¨ë‹¬ ë¨¼ì € ì—°ë‹¤!
            setTimeout(() => {
                const form = document.getElementById('expenseForm');
                if (!form) return;
                form.querySelector('select[name="pet"]').value = data.cat.id || '';
                form.querySelector('input[name="purchase_date"]').value = data.purchase_date || '';
                form.querySelector('select[name="type"]').value = data.type || '';
                form.querySelector('input[name="price"]').value = data.price || '';
                form.querySelector('input[name="product_name"]').value = data.product_name || '';
                form.querySelector('input[name="purchase_link"]').value = data.purchase_link || '';
                form.querySelector('input[name="rating"]').value = data.rating || '';
                form.querySelector('textarea[name="memo"]').value = data.memo || '';
                // ë³„ì  UI ê°±ì‹ 
                const rating = parseInt(data.rating || '0');
                document.querySelectorAll('.rating-star').forEach((star, idx) => {
                    if (idx < rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }, 50);
        });
}

function saveExpense() {
    const formData = new FormData(document.getElementById('expenseForm'));
    let url = '/food/api/purchases/other/';
    let method = 'POST';
    if (editingExpenseId) {
        url = `/items/api/otherpurchase/${editingExpenseId}/`;
        method = 'PUT';
    }
    fetch(url, {
        method: method,
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success || data.id) {
            alert(editingExpenseId ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeExpenseModal();
            location.reload();
        } else {
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
    editingExpenseId = null;
}

// ëª¨ë‹¬ ë‹«ì„ ë•Œ editingExpenseId ì´ˆê¸°í™”
function closeExpenseModal() {
    document.getElementById('expenseModal').classList.remove('active');
    document.body.style.overflow = 'auto';
    document.getElementById('expenseForm').reset();
    editingExpenseId = null;
    // ë³„ì  ì´ˆê¸°í™”
    document.querySelectorAll('.rating-star').forEach(star => {
        star.classList.remove('active');
    });
    document.querySelector('input[name="rating"]').value = '0';
}

// ì§€ì¶œ ì‚­ì œ
function deleteExpense(expenseId) {
    if (confirm('ì´ ì§€ì¶œ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch(`/items/api/otherpurchase/${expenseId}/`, {
        method: 'DELETE',
        headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
    })
    .then(response => {
        if (response.ok) {
                location.reload();
        } else {
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
            console.error('Error:', error);
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
document.getElementById('expenseModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeExpenseModal();
    }
});
</script>
{% endblock %} 