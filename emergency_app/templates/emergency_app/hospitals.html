{% extends 'common_app/base.html' %}
{% load static %}

{% block title %}병원 찾기 - 냥이 집사{% endblock %}

{% block content %}
<div class="weight-header">
  <div class="weight-nav">
    <div class="nav-left">
      <button class="back-btn" onclick="history.back()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <span class="weight-title">
        <i class="fas fa-hospital"></i>
        병원찾기
      </span>
    </div>
  </div>
</div>

<style>
.weight-header {
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
  padding: 24px 0 16px 0;
}
.weight-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  max-width: 1200px;
  margin: 0 auto;
  margin-bottom: 0;
}
.nav-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.back-btn {
  background: none;
  border: none;
  font-size: 24px;
  color: #222f3e;
  cursor: pointer;
  padding: 4px;
  border-radius: 8px;
  transition: background-color 0.2s;
}
.back-btn:hover {
  background: #f3f4f6;
}
.weight-title {
  font-size: 24px;
  font-weight: 700;
  color: #222f3e;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.weight-title i {
  color: #222f3e;
  background: #f3f4f6;
  border-radius: 8px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}
.page-hide-nav {
    display: none !important;
}

/* Hide default header/nav */
.navbar, .nav-section, .header-section, .breadcrumb-section {
    display: none !important;
}

.main-container {
    padding: 0 !important;
    max-width: none !important;
    background: var(--color-background) !important;
}

/* Hospital finder specific styles */
.hospital-page {
    min-height: 100vh;
    background: var(--color-background);
    font-family: var(--font-primary);
}

.hospital-header {
    background: white;
    border-bottom: 1px solid var(--color-border);
    padding: var(--spacing-lg) var(--spacing-xl);
}

.hospital-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    margin-bottom: var(--spacing-lg);
}

.nav-left {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.back-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--color-text);
    cursor: pointer;
    padding: var(--spacing-xs);
    border-radius: var(--border-radius-md);
    transition: background-color 0.2s;
}

.back-btn:hover {
    background: var(--color-surface);
}

.hospital-title {
    font-size: 24px;
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0;
}

.nav-right {
    display: flex;
    gap: var(--spacing-sm);
}

.nav-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    color: var(--color-text);
    text-decoration: none;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    transition: all 0.2s;
}

.nav-btn:hover {
    background: var(--color-primary-light);
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.hospital-search-section {
    max-width: 1200px;
    margin: 0 auto;
}

.search-controls {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
}

.search-box {
    flex: 1;
    position: relative;
}

.search-input {
    width: 100%;
    padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) 48px;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    background: white;
    font-size: var(--font-size-md);
    color: var(--color-text);
}

.search-input::placeholder {
    color: var(--color-text-muted);
}

.search-icon {
    position: absolute;
    left: var(--spacing-md);
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    font-size: 20px;
}

.search-btn {
    min-width: 100px;
    padding: 10px 28px;
    border: 2px solid #3182f6;
    border-radius: 999px;
    background: #fff;
    color: #3182f6;
    font-size: 16px;
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 2px 12px rgba(49,130,246,0.10);
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    letter-spacing: 1px;
}
.search-btn:hover, .search-btn:focus {
    background: #3182f6;
    color: #fff;
    border: 2px solid #2563c6;
    box-shadow: 0 4px 18px rgba(49,130,246,0.13);
    outline: none;
}
.search-btn:active {
    background: #2563c6;
    color: #fff;
    border: 2px solid #174ea6;
    box-shadow: 0 2px 8px rgba(49,130,246,0.10);
}

.hospital-main {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    gap: var(--spacing-xl);
    min-height: 500px;
}

.map-section {
    flex: 1;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-lg);
    max-height: 600px;
}

.map-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
}

.map-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0;
}

.map-container {
    height: 400px;
    border-radius: var(--border-radius-lg);
    background: var(--color-surface);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: var(--spacing-md);
    color: var(--color-text-muted);
}

.map-placeholder-icon {
    font-size: 48px;
    opacity: 0.5;
}

.hospital-list-section {
    flex: 1;
    max-height: 600px;
    overflow-y: auto;
}

.hospital-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.hospital-card {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-lg);
    transition: all 0.2s;
    cursor: pointer;
}

.hospital-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary-light);
    transform: translateY(-2px);
}

.hospital-card.initial-message:hover {
    box-shadow: none;
    border-color: var(--color-border);
    transform: none;
    cursor: default;
}

.hospital-header {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.hospital-image {
    width: 80px;
    height: 80px;
    border-radius: var(--border-radius-lg);
    object-fit: cover;
    background: var(--color-surface);
}

.hospital-info {
    flex: 1;
}

.hospital-name-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-xs);
}

.hospital-name {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0;
}

.emergency-badge {
    background: var(--color-danger);
    color: white;
    padding: 4px var(--spacing-sm);
    border-radius: var(--border-radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
}

.hospital-rating {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-sm);
}

.rating-star {
    color: #fbbf24;
}

.rating-text {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.hospital-details {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-md);
}

.detail-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.detail-icon {
    color: var(--color-text-light);
}

.hospital-specialties {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-md);
}

.specialty-tag {
    padding: 4px var(--spacing-sm);
    background: var(--color-primary-lightest);
    color: var(--color-primary);
    border-radius: var(--border-radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
}

.hospital-actions {
    display: flex;
    gap: var(--spacing-sm);
}

.action-btn {
    flex: 1;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--border-radius-lg);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    text-decoration: none;
    text-align: center;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xs);
}

.btn-primary {
    background: var(--color-primary);
    color: white;
    border: none;
}

.btn-primary:hover {
    background: var(--color-primary-dark);
    color: white;
}

.btn-secondary {
    background: white;
    color: var(--color-text);
    border: 1px solid var(--color-border);
}

.btn-secondary:hover {
    background: var(--color-surface);
    color: var(--color-text);
}

.emergency-section {
    max-width: 1200px;
    margin: var(--spacing-xl) auto 0;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-lg);
}

.emergency-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-danger);
    margin: 0 0 var(--spacing-lg) 0;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.emergency-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-xl);
}

.checklist-section h4 {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0 0 var(--spacing-md) 0;
}

.checklist {
    list-style: none;
    padding: 0;
    margin: 0;
}

.checklist li {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
    padding-left: var(--spacing-md);
    position: relative;
}

.checklist li::before {
    content: "•";
    color: var(--color-danger);
    font-weight: bold;
    position: absolute;
    left: 0;
}

.emergency-contacts {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.contact-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm);
    background: white;
    border-radius: var(--border-radius-md);
}

.contact-name {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
}

.contact-phone {
    font-size: var(--font-size-sm);
    color: var(--color-primary);
    font-weight: var(--font-weight-medium);
}

@media (max-width: 768px) {
    .hospital-main {
        flex-direction: column;
    }
    
    .search-controls {
        flex-direction: column;
    }
    
    .emergency-content {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .emergency-section {
        padding: 24px 20px;
    }
    
    .checklist-section {
        padding: 20px;
    }
    
    .favorite-hospital-card {
        padding: 16px;
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .favorite-hospital-info {
        margin-left: 8px;
        width: 100%;
    }
    
    .favorite-hospital-actions {
        align-self: flex-end;
        margin-top: 8px;
    }
    
    .hospital-actions {
        flex-direction: column;
    }
    
    .hospital-header {
        padding: var(--spacing-md);
    }
}

.action-btn.btn-primary {
    background: #fff !important;
    color: #3182f6 !important;
    border: 2px solid #3182f6 !important;
    font-weight: 700;
    border-radius: 999px;
    box-shadow: 0 2px 12px rgba(49,130,246,0.10);
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
}
.action-btn.btn-primary:hover,
.action-btn.btn-primary:focus {
    background: #3182f6 !important;
    color: #fff !important;
    border: 2px solid #2563c6 !important;
    box-shadow: 0 4px 18px rgba(49,130,246,0.13);
    outline: none;
}
.action-btn.btn-primary:active {
    background: #2563c6 !important;
    color: #fff !important;
    border: 2px solid #174ea6 !important;
    box-shadow: 0 2px 8px rgba(49,130,246,0.10);
}

.action-btn.btn-secondary {
    background: #fff !important;
    color: #3182f6 !important;
    border: 2px solid #3182f6 !important;
    font-weight: 700;
    border-radius: 999px;
    box-shadow: 0 2px 12px rgba(49,130,246,0.10);
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
}
.action-btn.btn-secondary:hover,
.action-btn.btn-secondary:focus {
    background: #3182f6 !important;
    color: #fff !important;
    border: 2px solid #2563c6 !important;
    box-shadow: 0 4px 18px rgba(49,130,246,0.13);
    outline: none;
}
.action-btn.btn-secondary:active {
    background: #2563c6 !important;
    color: #fff !important;
    border: 2px solid #174ea6 !important;
    box-shadow: 0 2px 8px rgba(49,130,246,0.10);
}

.hospital-main-narrow {
  max-width: 1000px;
  margin: 0 auto;
  width: 100%;
  padding: 32px 0 0 0;
}
.hospital-card-style {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  box-shadow: 0 2px 12px 0 rgb(0 0 0 / 4%);
  padding: 32px 32px 24px 32px;
  margin-bottom: 32px;
}
.hospital-search-section {
  margin: 0 0 32px 0;
  padding: 0;
}
.search-controls {
  display: flex;
  gap: 12px;
}
.search-box {
  flex: 1;
  position: relative;
}
.search-input {
  width: 100%;
  padding: 14px 16px 14px 44px;
  border: 1.5px solid #e5e7eb;
  border-radius: 12px;
  background: #fff;
  font-size: 16px;
  color: #222f3e;
}
.search-input::placeholder {
  color: #b0b8c1;
}
.search-icon {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: #b0b8c1;
  font-size: 20px;
}
.search-btn {
  min-width: 100px;
  padding: 12px 28px;
  border: 2px solid #3182f6;
  border-radius: 999px;
  background: transparent;
  color: #3182f6;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 2px 12px rgba(49,130,246,0.10);
  transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
  letter-spacing: 1px;
}
.search-btn:hover, .search-btn:focus {
  background: #3182f6;
  color: #fff;
  border: 2px solid #2563c6;
  box-shadow: 0 4px 18px rgba(49,130,246,0.13);
  outline: none;
}

.hospital-main {
  display: flex;
  gap: 32px;
  margin-bottom: 32px;
}
.map-section, .hospital-list-section {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  box-shadow: 0 2px 12px 0 rgb(0 0 0 / 4%);
  padding: 24px;
}
.map-section {
  flex: 1;
  min-width: 340px;
}
.hospital-list-section {
  flex: 1;
  min-width: 340px;
}
.map-header, .hospital-list-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}
.map-title, .hospital-list-title {
  font-size: 18px;
  font-weight: 600;
  color: #222f3e;
  margin: 0;
}
.emergency-section {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border: 1px solid #e2e8f0;
  border-radius: 20px;
  padding: 32px;
  margin-bottom: 32px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  position: relative;
}
.emergency-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #f59e0b, #ef4444);
  border-radius: 20px 20px 0 0;
}
.emergency-title {
  font-size: 20px;
  font-weight: 700;
  color: #1e293b;
  margin: 0 0 24px 0;
  display: flex;
  align-items: center;
  gap: 12px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.emergency-title i {
  font-size: 24px;
  color: #f59e0b;
}
.emergency-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 32px;
}
.checklist-section {
  background: white;
  padding: 24px;
  border-radius: 16px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}
.checklist-section h4 {
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
  margin: 0 0 16px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.checklist-section h4::before {
  content: '';
  width: 4px;
  height: 20px;
  background: linear-gradient(135deg, #f59e0b, #ef4444);
  border-radius: 2px;
}
.checklist {
  list-style: none;
  padding: 0;
  margin: 0;
}
.checklist li {
  font-size: 14px;
  color: #374151;
  margin-bottom: 10px;
  padding: 8px 16px 8px 32px;
  position: relative;
  background: #f8fafc;
  border-radius: 8px;
  border-left: 3px solid #cbd5e1;
  transition: all 0.2s;
}
.checklist li:hover {
  transform: translateX(2px);
  border-left-color: #f59e0b;
  background: #fef3c7;
}
.checklist li::before {
  content: "⚠️";
  position: absolute;
  left: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 12px;
}
.emergency-contacts {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.contact-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  background: none;
  border-radius: 8px;
}
.contact-name {
  font-size: 14px;
  font-weight: 500;
  color: #222f3e;
}
.contact-phone {
  font-size: 14px;
  color: #3182f6;
  font-weight: 600;
}

/* 즐겨찾기 병원 스타일 */
.favorite-hospitals-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  max-height: 280px;
  overflow-y: auto;
  padding-right: 8px;
}
.favorite-hospitals-grid::-webkit-scrollbar {
  width: 6px;
}
.favorite-hospitals-grid::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}
.favorite-hospitals-grid::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}
.favorite-hospitals-grid::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1;
}
.favorite-hospital-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border: 1px solid #e2e8f0;
  border-radius: 16px;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}
.favorite-hospital-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  transition: width 0.3s;
}
.favorite-hospital-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.12);
  border-color: #cbd5e1;
}
.favorite-hospital-card:hover::before {
  width: 6px;
}
.favorite-hospital-info {
  flex: 1;
  margin-left: 12px;
}
.favorite-hospital-name {
  font-size: 17px;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.favorite-hospital-name::before {
  content: "🏥";
  font-size: 16px;
}
.favorite-hospital-address {
  font-size: 13px;
  color: #64748b;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.favorite-hospital-address::before {
  content: "📍";
  font-size: 12px;
}
.favorite-hospital-phone {
  font-size: 14px;
  color: #3182f6;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}
.favorite-hospital-phone::before {
  content: "📞";
  font-size: 12px;
}
.favorite-hospital-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}
.favorite-action-btn {
  width: 40px;
  height: 40px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
  color: #64748b;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  text-decoration: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.favorite-action-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  color: #334155;
  text-decoration: none;
}
.favorite-action-btn:first-child {
  background: linear-gradient(135deg, #dbeafe, #bfdbfe);
  color: #3182f6;
}
.favorite-action-btn:first-child:hover {
  background: linear-gradient(135deg, #bfdbfe, #93c5fd);
  color: #1d4ed8;
}
.favorite-action-btn:last-child {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  color: #f59e0b;
}
.favorite-action-btn:last-child:hover {
  background: linear-gradient(135deg, #fde68a, #fcd34d);
  color: #d97706;
}
.no-favorites {
  text-align: center;
  padding: 32px 24px;
  color: #64748b;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 16px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.no-favorites i {
  display: block;
  margin-bottom: 16px;
  font-size: 32px;
  color: #cbd5e1;
}
.no-favorites p {
  margin: 6px 0;
  font-size: 14px;
  line-height: 1.5;
}
.no-favorites p:first-of-type {
  font-weight: 600;
  color: #475569;
  font-size: 16px;
}
.login-required {
  text-align: center;
  padding: 32px 24px;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 16px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.login-required p {
  margin: 0;
  font-size: 15px;
  color: #64748b;
  line-height: 1.5;
}
.login-required a {
  color: #3182f6;
  text-decoration: none;
  font-weight: 600;
  background: linear-gradient(135deg, #3182f6, #1d4ed8);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.login-required a:hover {
  text-decoration: underline;
}

/* 즐겨찾기 별표 버튼 스타일 */
.favorite-star-btn {
  width: 32px;
  height: 32px;
  border: none;
  border-radius: 50%;
  background: rgba(251, 191, 36, 0.1);
  color: #fbbf24;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  margin: 0;
}
.favorite-star-btn:hover {
  background: rgba(251, 191, 36, 0.2);
  transform: scale(1.1);
}
.favorite-star-btn.favorited {
  background: #fbbf24;
  color: white;
}
.favorite-star-btn.favorited:hover {
  background: #f59e0b;
}
.favorite-star-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}
</style>

<div class="hospital-main-narrow">
  <!-- 검색 카드 -->
  <div class="hospital-search-section">
    <div class="search-controls">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" placeholder="병원명 또는 주소로 검색..." value="{{ search_query|default:'' }}">
      </div>
      <button class="search-btn" onclick="performSearch()">
        <i class="fas fa-search"></i>
        조회
      </button>
    </div>
  </div>

  <!-- 지도/리스트 카드 -->
  <div class="hospital-main">
    <div class="map-section">
      <div class="map-header">
        <i class="fas fa-map-marker-alt" style="color: #3182f6;"></i>
        <h3 class="map-title">주변 병원 지도</h3>
      </div>
      <div class="map-container" id="map" style="height:520px;"></div>
    </div>
    <div class="hospital-list-section">
      <div class="hospital-list-header">
        <i class="fas fa-hospital"></i>
        <h3 class="hospital-list-title">병원 리스트</h3>
      </div>
      <div class="hospital-list">
        <!-- 기존 병원 리스트 내용 -->
        {% block hospital_list %}{% endblock %}
      </div>
    </div>
  </div>

  <!-- 응급 가이드 카드 -->
  <div class="emergency-section">
    <h3 class="emergency-title">
      <i class="fas fa-exclamation-triangle"></i>
      응급상황 대응 가이드
    </h3>
    <div class="emergency-content">
      <div class="checklist-section">
        <h4>응급 증상 체크리스트</h4>
        <ul class="checklist">
          <li>호흡곤란 또는 과도한 헐떡임</li>
          <li>의식을 잃거나 경련 증상</li>
          <li>심한 구토나 설사가 지속됨</li>
          <li>외상으로 인한 출혈</li>
          <li>중독 의심 증상 (구토, 경련 등)</li>
          <li>체온이 급격히 오르거나 내려감</li>
        </ul>
      </div>
      <div class="checklist-section">
        <h4>나의 즐겨찾기 병원</h4>
        {% if user.is_authenticated %}
          <div class="favorite-hospitals-table" id="favorite-hospitals-container">
            {% if favorite_hospitals %}
              <div class="favorite-hospitals-grid">
                {% for favorite in favorite_hospitals %}
                  <div class="favorite-hospital-card" data-hospital-id="{{ favorite.hospital.id }}">
                    <div class="favorite-hospital-info">
                      <div class="favorite-hospital-name">{{ favorite.hospital.name }}</div>
                      <div class="favorite-hospital-address">{{ favorite.hospital.address }}</div>
                      <div class="favorite-hospital-phone">{{ favorite.hospital.phone }}</div>
                    </div>
                    <div class="favorite-hospital-actions">
                      <a href="tel:{{ favorite.hospital.phone }}" class="favorite-action-btn">
                        <i class="fas fa-phone"></i>
                      </a>
                      <button class="favorite-action-btn remove-favorite" onclick="toggleFavorite({{ favorite.hospital.id }})" title="즐겨찾기 해제">
                        <i class="fas fa-star" style="color: #fbbf24;"></i>
                      </button>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="no-favorites">
                <i class="fas fa-star" style="color: #ccc; font-size: 24px; margin-bottom: 8px;"></i>
                <p>즐겨찾기한 병원이 없습니다.</p>
                <p>병원 검색 후 별표 버튼을 눌러 즐겨찾기에 추가해보세요.</p>
              </div>
            {% endif %}
          </div>
        {% else %}
          <div class="login-required">
            <p>즐겨찾기 기능을 사용하려면 <a href="{% url 'common_app:login' %}">로그인</a>이 필요합니다.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script id="hospital-data" type="application/json">
[
{% for hospital in hospitals %}
{
    "dbId": {{ hospital.id }},
    "name": "{{ hospital.name|escapejs }}",
    "lat": {{ hospital.latitude }},
    "lng": {{ hospital.longitude }},
    "address": "{{ hospital.address|escapejs }}",
    "phone": "{{ hospital.phone|escapejs }}",
    "distance": "{{ hospital.distance_km }}",
    "isEmergency": {{ hospital.is_emergency|yesno:"true,false" }},
    "rating": {{ hospital.rating }}
}{% if not forloop.last %},{% endif %}
{% endfor %}
]
</script>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=679cb0dcbdbd689c815830cfcb681150&libraries=services"></script>
<script>
function openDirections(address) {
    const encodedAddress = encodeURIComponent(address);
    window.open(`https://map.kakao.com/?q=${encodedAddress}`, '_blank');
}

const hospitals = JSON.parse(document.getElementById('hospital-data').textContent);
const isUserAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
const favoriteHospitalIds = {{ favorite_hospital_ids|safe }};

// 카카오 API 검색 변수들
const ps = new kakao.maps.services.Places();
let markers = [];
let infowindow = new kakao.maps.InfoWindow({zIndex:1});
let searchResults = [];
let currentMap = null;
let userLocation = { lat: 37.5665, lng: 126.9780 }; // 기본값: 서울 중심부

// 마커를 placeId(또는 name+좌표)로 매핑
let markerMap = {};

// 기존 맵 초기화 함수 수정
function initMap() {
    if (!window.kakao || !window.kakao.maps) return;
    const container = document.getElementById('map');
    if (!container) return;
    
    // 기본 중심점을 서울로 설정
    const center = new kakao.maps.LatLng(37.5665, 126.9780);
    currentMap = new kakao.maps.Map(container, {
        center: center,
        level: 6
    });
    
    // 초기 상태에서 병원 리스트에 안내 메시지 표시
    showInitialMessage();
}

// 초기 안내 메시지 표시 함수  
function showInitialMessage() {
    const hospitalListContainer = document.querySelector('.hospital-list');
    if (!hospitalListContainer) return;
    
    hospitalListContainer.innerHTML = `
        <div class="hospital-card initial-message">
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: var(--spacing-md); opacity: 0.3; color: #3182f6;"></i>
                <h4 style="margin-bottom: var(--spacing-sm); color: var(--color-text);">병원을 검색해보세요</h4>
                <p style="margin-bottom: 0;">병원명이나 지역명을 입력하여</p>
                <p style="margin: 0;">주변 동물병원을 찾아보실 수 있습니다.</p>
            </div>
        </div>
    `;
}

// 병원 데이터를 지도와 리스트에 표시하는 함수
function displayHospitals(hospitalData) {
    // 기존 마커 제거
    markers.forEach(m => m.setMap(null));
    markers = [];
    markerMap = {};
    infowindow.close();
    
    const bounds = new kakao.maps.LatLngBounds();
    
    hospitalData.forEach(function(hospital) {
        if (hospital.lat && hospital.lng) {
            const marker = new kakao.maps.Marker({
                map: currentMap,
                position: new kakao.maps.LatLng(hospital.lat, hospital.lng),
                title: hospital.name
            });
            markers.push(marker);
            
            // placeId가 있으면 placeId로, 없으면 name+lat+lng로 매핑
            const key = hospital.placeId || (hospital.name + '_' + hospital.lat + '_' + hospital.lng);
            markerMap[key] = marker;

            kakao.maps.event.addListener(marker, 'click', function() {
                let content;
                
                // 검색된 병원인지 기존 병원인지 구분
                if (hospital.category && hospital.placeUrl) {
                    // 검색된 병원 (카카오 API 결과)
                    content = `
                      <div style="padding:10px; font-size:13px; min-width:220px;">
                        <div><b>📍 ${hospital.name}</b></div>
                        ${hospital.phone && hospital.phone !== '정보 없음' ? `<div>📞 ${hospital.phone}</div>` : ''}
                        <div>📫 ${hospital.address}</div>
                        <div>🏷 ${hospital.category}</div>
                        <a href="${hospital.placeUrl}" target="_blank" style="color:#3182f6; text-decoration:underline;">카카오맵에서 보기</a>
                      </div>
                    `;
                } else {
                    // 기존 병원 (DB 데이터)
                    content = `
                      <div style="padding:10px; font-size:13px; min-width:220px;">
                        <div><b>📍 ${hospital.name}</b></div>
                        ${hospital.phone && hospital.phone !== '정보 없음' ? `<div>📞 ${hospital.phone}</div>` : ''}
                        <div>📫 ${hospital.address}</div>
                        <div>🏷 동물병원</div>
                      </div>
                    `;
                }
                
                infowindow.setContent(content);
                infowindow.open(currentMap, marker);
            });
            
            bounds.extend(new kakao.maps.LatLng(hospital.lat, hospital.lng));
        }
    });
    
    if (hospitalData.length > 0 && hospitalData.some(h => h.lat && h.lng)) {
        currentMap.setBounds(bounds);
    }
    // 병원 리스트 업데이트
    updateHospitalList(hospitalData);
}

// 카카오 API 검색 함수
function searchAnimalHospitals(keyword) {
    if (!keyword.trim()) {
        // 검색어가 없으면 빈 상태로 유지
        markers.forEach(m => m.setMap(null));
        markers = [];
        infowindow.close();
        showInitialMessage();
        return;
    }
    
    const searchKeyword = keyword.trim() + ' 동물병원';
    
    // DB 병원에서 먼저 검색
    const dbResults = hospitals.filter(hospital => 
        hospital.name.toLowerCase().includes(keyword.toLowerCase()) ||
        hospital.address.toLowerCase().includes(keyword.toLowerCase())
    );
    
    console.log('DB 검색 결과:', dbResults);
    
    // 카카오 API 검색
    ps.keywordSearch(searchKeyword, function(data, status, pagination) {
        let allResults = [...dbResults]; // DB 결과를 먼저 추가
        
        if (status === kakao.maps.services.Status.OK) {
            console.log('카카오 API 응답 데이터:', data); // 디버그용
            
            // 동물병원 관련 키워드로 필터링
            const keywords = ['동물', '애완', '반려', '펫', '캣', 'dog', 'cat', '고양이', '강아지'];
            const filtered = data.filter(place =>
                keywords.some(word => place.place_name.toLowerCase().includes(word))
            );
            
            // 각 병원에 대해 추가 정보 가져오기
            const promises = filtered.map(place => getHospitalDetails(place));
            
            Promise.all(promises).then(convertedResults => {
                // DB 결과와 API 결과 합치기
                allResults = [...dbResults, ...convertedResults];
                searchResults = allResults;
                displayHospitals(allResults);
                updateHospitalList(allResults);
            });
        } else {
            // 카카오 API 결과가 없어도 DB 결과가 있으면 표시
            if (dbResults.length > 0) {
                searchResults = dbResults;
                displayHospitals(dbResults);
                updateHospitalList(dbResults);
            } else {
                // 완전히 검색 결과가 없을 때만 안내 메시지 표시
                const hospitalListContainer = document.querySelector('.hospital-list');
                if (hospitalListContainer) {
                    hospitalListContainer.innerHTML = `
                        <div class="hospital-card initial-message">
                            <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                                <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: var(--spacing-md); opacity: 0.3; color: #f59e0b;"></i>
                                <h4 style="margin-bottom: var(--spacing-sm); color: var(--color-text);">검색 결과가 없습니다</h4>
                                <p style="margin-bottom: 0;">다른 검색어로 시도해보세요.</p>
                                <p style="margin: 0;">예: "서울 동물병원", "강남구", "24시간" 등</p>
                            </div>
                        </div>
                    `;
                }
            }
        }
    });
}

// 병원 상세 정보 가져오기
async function getHospitalDetails(place) {
    // 기본 정보만 사용
    const hospitalInfo = {
        name: place.place_name,
        lat: parseFloat(place.y),
        lng: parseFloat(place.x),
        address: place.road_address_name || place.address_name,
        phone: place.phone || '정보 없음',
        category: place.category_name,
        placeId: place.id,
        placeUrl: place.place_url
    };
    
    // 거리 계산 (사용자 위치 기준, 없으면 서울 중심부)
    const userLocation = getUserLocation();
    const userLat = userLocation.lat;
    const userLng = userLocation.lng;
    hospitalInfo.distance = calculateDistance(userLat, userLng, hospitalInfo.lat, hospitalInfo.lng);
    
    // 카테고리 기반으로 응급실 여부만 판단
    hospitalInfo.isEmergency = hospitalInfo.category && hospitalInfo.category.includes('24시');
    
    return hospitalInfo;
}

// 사용자 위치 가져오기
function getUserLocation() {
    return userLocation;
}

// 사용자의 현재 위치 요청
function requestUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation.lat = position.coords.latitude;
                userLocation.lng = position.coords.longitude;
                console.log('사용자 위치 업데이트:', userLocation);
                
                // 지도 중심을 사용자 위치로 이동
                if (currentMap) {
                    const center = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);
                    currentMap.setCenter(center);
                }
            },
            function(error) {
                console.log('위치 정보를 가져올 수 없습니다:', error.message);
                // 기본값 유지
            }
        );
    }
}

// 거리 계산 함수 (km 단위)
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // 지구의 반지름 (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return (R * c).toFixed(1);
}

// 조회 버튼 클릭 함수
function performSearch() {
    const searchInput = document.querySelector('.search-input');
    const searchValue = searchInput.value.trim();
    
    if (!searchValue) {
        alert('검색어를 입력해주세요.');
        searchInput.focus();
        return;
    }
    
    searchAnimalHospitals(searchValue);
}

// 병원 리스트 클릭 시 지도 이동/마커 강조 (placeId 매칭)
function addHospitalListClickHandlers(hospitalData) {
  const cards = document.querySelectorAll('.hospital-card');
  cards.forEach((card, idx) => {
    card.addEventListener('click', function(e) {
      // 버튼 클릭 시에는 지도 이동하지 않음
      if (e.target.closest('.action-btn')) {
        return;
      }
      
      const lat = parseFloat(card.getAttribute('data-lat'));
      const lng = parseFloat(card.getAttribute('data-lng'));
      const placeId = card.getAttribute('data-place-id');
      const hospitalName = card.querySelector('.hospital-name').textContent;
      
      // 마커 키 생성
      let key = placeId;
      if (!key) {
        key = hospitalName + '_' + lat + '_' + lng;
      }
      
      const marker = markerMap[key];
      
      if (!isNaN(lat) && !isNaN(lng) && currentMap) {
        const moveLatLon = new kakao.maps.LatLng(lat, lng);
        
        // 지도 중심 이동 및 확대
        currentMap.panTo(moveLatLon);
        currentMap.setLevel(3);
        
        // 마커가 있으면 정보창 표시
        if (marker) {
          // 해당 병원 정보 찾기
          const hospital = hospitalData[idx];
          if (hospital) {
            let content;
            
            // 검색된 병원인지 기존 병원인지 구분하여 정보창 내용 생성
            if (hospital.category && hospital.placeUrl) {
              // 검색된 병원 (카카오 API 결과)
              content = `
                <div style="padding:15px; font-size:14px; min-width:250px; line-height:1.4;">
                  <div style="font-weight:bold; font-size:16px; margin-bottom:8px; color:#222;">📍 ${hospital.name}</div>
                  ${hospital.phone && hospital.phone !== '정보 없음' ? `<div style="margin-bottom:5px;">📞 ${hospital.phone}</div>` : ''}
                  <div style="margin-bottom:5px;">📫 ${hospital.address}</div>
                  <div style="margin-bottom:8px;">🏷 ${hospital.category}</div>
                  <div style="margin-bottom:5px;">📍 거리: ${hospital.distance}km</div>
                  <div style="margin-top:10px;">
                    <a href="${hospital.placeUrl}" target="_blank" style="color:#3182f6; text-decoration:underline; font-weight:500;">카카오맵에서 자세히 보기</a>
                  </div>
                </div>
              `;
            } else {
              // 기존 병원 (DB 데이터)
              content = `
                <div style="padding:15px; font-size:14px; min-width:250px; line-height:1.4;">
                  <div style="font-weight:bold; font-size:16px; margin-bottom:8px; color:#222;">📍 ${hospital.name}</div>
                  ${hospital.phone && hospital.phone !== '정보 없음' ? `<div style="margin-bottom:5px;">📞 ${hospital.phone}</div>` : ''}
                  <div style="margin-bottom:5px;">📫 ${hospital.address}</div>
                  <div style="margin-bottom:8px;">🏷 동물병원</div>
                  <div style="margin-bottom:5px;">📍 거리: ${hospital.distance}km</div>
                </div>
              `;
            }
            
            infowindow.setContent(content);
            infowindow.open(currentMap, marker);
          }
        } else {
          console.log('마커를 찾을 수 없음:', key);
        }
      }
      
      // 카드 선택 효과 (선택적)
      cards.forEach(c => c.style.backgroundColor = '');
      card.style.backgroundColor = '#f8fafc';
      setTimeout(() => {
        card.style.backgroundColor = '';
      }, 2000);
    });
  });
}

// 병원 리스트 업데이트 함수 수정
function updateHospitalList(hospitalData) {
  const hospitalListContainer = document.querySelector('.hospital-list');
  if (!hospitalListContainer) return;

  if (hospitalData.length === 0) {
    hospitalListContainer.innerHTML = `
        <div class="hospital-card initial-message">
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: var(--spacing-md); opacity: 0.3;"></i>
                <p>검색 결과가 없습니다.</p>
                <p>다른 검색어를 입력해보세요.</p>
            </div>
        </div>
    `;
    return;
  }

  let listHtml = '';
  hospitalData.forEach((hospital, idx) => {
    // 응급실 배지
    const emergencyBadge = hospital.isEmergency ? 
        '<span class="emergency-badge">응급</span>' : '';
    const placeIdAttr = hospital.placeId ? `data-place-id="${hospital.placeId}"` : '';
    
    // DB 병원인지 확인 (dbId가 있으면 DB 병원)
    const isDbHospital = hospital.dbId !== undefined;
    const isFavorited = isDbHospital && favoriteHospitalIds.includes(hospital.dbId);
    
    // 모든 로그인 사용자에게 즐겨찾기 버튼 표시 (DB 병원은 실제 기능, 검색 병원은 새 함수 사용)
    const favoriteButton = isUserAuthenticated ? 
        `<button class="favorite-star-btn ${isFavorited ? 'favorited' : ''}" onclick="${isDbHospital ? `toggleFavorite(${hospital.dbId}, this)` : `directAddToFavorites(${idx})`}" title="${isFavorited ? '즐겨찾기 해제' : '즐겨찾기'}">
            <i class="fas fa-star"></i>
         </button>` : '';
         
    console.log('Hospital:', hospital.name, 'isDbHospital:', isDbHospital, 'isAuthenticated:', isUserAuthenticated, 'favoriteButton:', favoriteButton);
    
    listHtml += `
        <div class="hospital-card" data-lat="${hospital.lat}" data-lng="${hospital.lng}" ${placeIdAttr}>
            <div class="hospital-header">
                <div class="hospital-image">
                    <i class="fas fa-hospital" style="color: var(--color-text-light); font-size: 24px; display: flex; align-items: center; justify-content: center; height: 100%;"></i>
                </div>
                <div class="hospital-info">
                    <div class="hospital-name-row">
                        <h3 class="hospital-name">${hospital.name}</h3>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${emergencyBadge}
                            ${favoriteButton}
                        </div>
                    </div>
                    <div class="hospital-rating">
                        <span class="rating-text">${hospital.distance}km</span>
                    </div>
                    <div class="hospital-details">
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt detail-icon"></i>
                            <span>${hospital.address}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-phone detail-icon"></i>
                            <span>${hospital.phone}</span>
                        </div>
                    </div>
                    <div class="hospital-actions">
                        <a href="tel:${hospital.phone}" class="action-btn btn-primary">
                            <i class="fas fa-phone"></i>
                            전화하기
                        </a>
                        <a href="#" class="action-btn btn-secondary" onclick="openDirections('${hospital.address}')">
                            <i class="fas fa-route"></i>
                            길찾기
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
  });

  hospitalListContainer.innerHTML = listHtml;
  
  // 병원 카드 클릭 이벤트 추가
  addHospitalListClickHandlers(hospitalData);
}

// 검색 기능
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('.search-input');
    
    if (searchInput) {
        // Enter 키 검색
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
    }
    
    // 조회 버튼 함수는 별도로 정의됨
    
    // 맵 초기화 및 위치 요청
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            requestUserLocation();
        });
    } else {
        initMap();
        requestUserLocation();
    }
});

// 즐겨찾기 토글 함수
function toggleFavorite(hospitalId, buttonElement) {
    console.log('=== DEBUG: toggleFavorite START ===');
    console.log('hospitalId:', hospitalId);
    console.log('buttonElement:', buttonElement);
    
    if (!hospitalId) {
        console.log('ERROR: hospitalId is null/undefined');
        alert('병원 정보를 찾을 수 없습니다.');
        return;
    }
    
    // 버튼 비활성화
    const button = buttonElement || event.target.closest('.favorite-star-btn');
    console.log('button element:', button);
    
    if (button) {
        console.log('button attributes:');
        for (let attr of button.attributes) {
            console.log(`  ${attr.name}: ${attr.value}`);
        }
        button.disabled = true;
    }
    
    // 검색된 병원인지 확인
    const isSearchHospital = button && button.hasAttribute('data-search-hospital');
    console.log('isSearchHospital:', isSearchHospital);
    console.log('has data-search-hospital attribute:', button ? button.hasAttribute('data-search-hospital') : 'no button');
    
    if (isSearchHospital) {
        console.log('Calling addSearchHospitalToFavorites...');
        // 검색된 병원을 DB에 추가하고 즐겨찾기
        addSearchHospitalToFavorites(hospitalId, button);
    } else {
        console.log('Calling toggleExistingHospitalFavorite...');
        // 기존 DB 병원 즐겨찾기 토글
        toggleExistingHospitalFavorite(hospitalId, button);
    }
}

// 기존 DB 병원 즐겨찾기 토글
function toggleExistingHospitalFavorite(hospitalId, button) {
    console.log('Calling toggleExistingHospitalFavorite with hospitalId:', hospitalId);
    console.log('URL will be:', `/emergency/favorite/${hospitalId}/`);
    
    fetch(`/emergency/favorite/${hospitalId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Success:', data);
        // 버튼 상태 업데이트
        if (button) {
            if (data.is_favorite) {
                button.classList.add('favorited');
                button.title = '즐겨찾기 해제';
                // favoriteHospitalIds 배열에 추가
                if (!favoriteHospitalIds.includes(hospitalId)) {
                    favoriteHospitalIds.push(hospitalId);
                }
            } else {
                button.classList.remove('favorited');
                button.title = '즐겨찾기';
                // favoriteHospitalIds 배열에서 제거
                const index = favoriteHospitalIds.indexOf(hospitalId);
                if (index > -1) {
                    favoriteHospitalIds.splice(index, 1);
                }
            }
            button.disabled = false;
        }
        
        // 즐겨찾기 목록 새로고침
        updateFavoritesList();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('즐겨찾기 처리 중 오류가 발생했습니다: ' + error.message);
        if (button) {
            button.disabled = false;
        }
    });
}

// 검색된 병원을 DB에 추가하고 즐겨찾기
function addSearchHospitalToFavorites(hospitalId, button) {
    console.log('=== DEBUG: addSearchHospitalToFavorites START ===');
    console.log('hospitalId:', hospitalId);
    console.log('button:', button);
    console.log('Current URL:', window.location.href);
    console.log('Origin:', window.location.origin);
    
    // hospitalId에서 인덱스 추출 (search_0, search_1, ...)
    const idx = hospitalId.replace('search_', '');
    console.log('extracted index:', idx);
    console.log('searchResults:', searchResults);
    console.log('searchResults length:', searchResults ? searchResults.length : 'undefined');
    
    const hospital = searchResults[parseInt(idx)];
    
    if (!hospital) {
        console.log('ERROR: 병원 정보를 찾을 수 없습니다.');
        console.log('Available searchResults indices:', Object.keys(searchResults || {}));
        alert('병원 정보를 찾을 수 없습니다.');
        button.disabled = false;
        return;
    }
    
    console.log('Adding hospital to favorites:', hospital);
    console.log('Hospital details:', {
        name: hospital.name,
        address: hospital.address,
        phone: hospital.phone,
        lat: hospital.lat,
        lng: hospital.lng
    });
    
    const targetUrl = '/emergency/add-search-hospital/';
    console.log('Target URL:', targetUrl);
    console.log('Full URL:', window.location.origin + targetUrl);
    
    // 폼 데이터 생성
    const formData = new FormData();
    formData.append('name', hospital.name);
    formData.append('address', hospital.address);
    formData.append('phone', hospital.phone || '정보 없음');
    formData.append('lat', hospital.lat);
    formData.append('lng', hospital.lng);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    console.log('FormData contents:');
    for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
    }
    
    console.log('About to send fetch request...');
    
    fetch(targetUrl, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('=== FETCH RESPONSE RECEIVED ===');
        console.log('Response status:', response.status);
        console.log('Response status text:', response.statusText);
        console.log('Response headers:', response.headers);
        console.log('Response URL:', response.url);
        console.log('Response OK:', response.ok);
        
        if (!response.ok) {
            return response.text().then(text => {
                console.log('=== ERROR RESPONSE BODY ===');
                console.log('Error response body:', text);
                console.log('=== ERROR RESPONSE BODY END ===');
                throw new Error(`HTTP error! status: ${response.status} - ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Search hospital added:', data);
        if (data.success) {
            // 버튼을 DB 병원 버튼으로 변경
            button.setAttribute('onclick', `toggleFavorite(${data.hospital_id}, this)`);
            button.removeAttribute('data-search-hospital');
            button.classList.add('favorited');
            button.title = '즐겨찾기 해제';
            button.disabled = false;
            
            // favoriteHospitalIds 배열에 추가
            if (!favoriteHospitalIds.includes(data.hospital_id)) {
                favoriteHospitalIds.push(data.hospital_id);
            }
            
            
            // 즐겨찾기 목록 새로고침
            updateFavoritesList();
        } else {
            alert(data.message || '즐겨찾기 추가 중 오류가 발생했습니다.');
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('즐겨찾기 추가 중 오류가 발생했습니다: ' + error.message);
        button.disabled = false;
    });
}

// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 즐겨찾기 목록 업데이트
function updateFavoritesList() {
    fetch('/emergency/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.text())
    .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newFavorites = doc.querySelector('#favorite-hospitals-container');
        const currentFavorites = document.querySelector('#favorite-hospitals-container');
        
        if (newFavorites && currentFavorites) {
            currentFavorites.innerHTML = newFavorites.innerHTML;
        }
    })
    .catch(error => {
        console.error('Error updating favorites list:', error);
    });
}

// 직접 즐겨찾기 추가 함수 (검색된 병원용)
function directAddToFavorites(hospitalIdx) {
    console.log('=== DIRECT ADD TO FAVORITES ===');
    console.log('hospitalIdx:', hospitalIdx);
    console.log('searchResults:', searchResults);
    
    if (!searchResults || hospitalIdx >= searchResults.length) {
        alert('병원 정보를 찾을 수 없습니다.');
        return;
    }
    
    const hospital = searchResults[hospitalIdx];
    console.log('Hospital to add:', hospital);
    
    if (!hospital.name || !hospital.address) {
        alert('병원 정보가 불완전합니다.');
        return;
    }
    
    // AJAX 요청으로 병원을 DB에 추가하고 즐겨찾기
    const formData = new FormData();
    formData.append('name', hospital.name);
    formData.append('address', hospital.address);
    formData.append('phone', hospital.phone || '정보 없음');
    formData.append('lat', hospital.lat || 0);
    formData.append('lng', hospital.lng || 0);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    console.log('Sending request to add hospital...');
    
    fetch('/emergency/add-search-hospital/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Success:', data);
        if (data.success) {
            
            // 즐겨찾기 목록 업데이트
            updateFavoritesList();
            
            // 해당 버튼 찾아서 상태 업데이트
            const buttons = document.querySelectorAll('.favorite-star-btn');
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(`directAddToFavorites(${hospitalIdx})`)) {
                    btn.setAttribute('onclick', `toggleFavorite(${data.hospital_id}, this)`);
                    btn.classList.add('favorited');
                    btn.title = '즐겨찾기 해제';
                }
            });
        } else {
            alert(data.message || '즐겨찾기 추가 중 오류가 발생했습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('즐겨찾기 추가 중 오류가 발생했습니다: ' + error.message);
    });
}

// 테스트 함수
function testAddHospital() {
    console.log('=== TEST FUNCTION CALLED ===');
    alert('테스트 함수가 호출되었습니다!');
    
    // 테스트용 병원 데이터
    const testHospital = {
        name: '테스트 동물병원',
        address: '서울시 테스트구 테스트동',
        phone: '02-1234-5678',
        lat: 37.5665,
        lng: 126.9780
    };
    
    const formData = new FormData();
    formData.append('name', testHospital.name);
    formData.append('address', testHospital.address);
    formData.append('phone', testHospital.phone);
    formData.append('lat', testHospital.lat);
    formData.append('lng', testHospital.lng);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    console.log('Sending test request...');
    
    fetch('/emergency/add-search-hospital/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Success:', data);
        alert('테스트 성공: ' + JSON.stringify(data));
    })
    .catch(error => {
        console.error('Error:', error);
        alert('테스트 실패: ' + error.message);
    });
}
</script>
{% endblock %} 