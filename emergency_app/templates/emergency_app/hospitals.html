{% extends 'common_app/base.html' %}
{% load static %}

{% block title %}ë³‘ì› ì°¾ê¸° - ëƒ¥ì´ ì§‘ì‚¬{% endblock %}

{% block content %}
<div class="weight-header">
  <div class="weight-nav">
    <div class="nav-left">
      <button class="back-btn" onclick="history.back()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <span class="weight-title">
        <i class="fas fa-hospital"></i>
        ë³‘ì›ì°¾ê¸°
      </span>
    </div>
  </div>
</div>

<style>
.weight-header {
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
  padding: 24px 0 16px 0;
}
.weight-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  max-width: 1200px;
  margin: 0 auto;
  margin-bottom: 0;
}
.nav-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.back-btn {
  background: none;
  border: none;
  font-size: 24px;
  color: #222f3e;
  cursor: pointer;
  padding: 4px;
  border-radius: 8px;
  transition: background-color 0.2s;
}
.back-btn:hover {
  background: #f3f4f6;
}
.weight-title {
  font-size: 24px;
  font-weight: 700;
  color: #222f3e;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.weight-title i {
  color: #222f3e;
  background: #f3f4f6;
  border-radius: 8px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}
.page-hide-nav {
    display: none !important;
}

/* Hide default header/nav */
.navbar, .nav-section, .header-section, .breadcrumb-section {
    display: none !important;
}

.main-container {
    padding: 0 !important;
    max-width: none !important;
    background: var(--color-background) !important;
}

/* Hospital finder specific styles */
.hospital-page {
    min-height: 100vh;
    background: var(--color-background);
    font-family: var(--font-primary);
}

.hospital-header {
    background: white;
    border-bottom: 1px solid var(--color-border);
    padding: var(--spacing-lg) var(--spacing-xl);
}

.hospital-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    margin-bottom: var(--spacing-lg);
}

.nav-left {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.back-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--color-text);
    cursor: pointer;
    padding: var(--spacing-xs);
    border-radius: var(--border-radius-md);
    transition: background-color 0.2s;
}

.back-btn:hover {
    background: var(--color-surface);
}

.hospital-title {
    font-size: 24px;
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0;
}

.nav-right {
    display: flex;
    gap: var(--spacing-sm);
}

.nav-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    color: var(--color-text);
    text-decoration: none;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    transition: all 0.2s;
}

.nav-btn:hover {
    background: var(--color-primary-light);
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.hospital-search-section {
    max-width: 1200px;
    margin: 0 auto;
}

.search-controls {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
}

.search-box {
    flex: 1;
    position: relative;
}

.search-input {
    width: 100%;
    padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) 48px;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    background: white;
    font-size: var(--font-size-md);
    color: var(--color-text);
}

.search-input::placeholder {
    color: var(--color-text-muted);
}

.search-icon {
    position: absolute;
    left: var(--spacing-md);
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    font-size: 20px;
}

.search-btn {
    min-width: 100px;
    padding: 10px 28px;
    border: 2px solid #3182f6;
    border-radius: 999px;
    background: #fff;
    color: #3182f6;
    font-size: 16px;
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 2px 12px rgba(49,130,246,0.10);
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    letter-spacing: 1px;
}
.search-btn:hover, .search-btn:focus {
    background: #3182f6;
    color: #fff;
    border: 2px solid #2563c6;
    box-shadow: 0 4px 18px rgba(49,130,246,0.13);
    outline: none;
}
.search-btn:active {
    background: #2563c6;
    color: #fff;
    border: 2px solid #174ea6;
    box-shadow: 0 2px 8px rgba(49,130,246,0.10);
}

.hospital-main {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    gap: var(--spacing-xl);
    min-height: 500px;
}

.map-section {
    flex: 1;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-lg);
    max-height: 600px;
}

.map-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
}

.map-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0;
}

.map-container {
    height: 400px;
    border-radius: var(--border-radius-lg);
    background: var(--color-surface);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: var(--spacing-md);
    color: var(--color-text-muted);
}

.map-placeholder-icon {
    font-size: 48px;
    opacity: 0.5;
}

.hospital-list-section {
    flex: 1;
    max-height: 600px;
    overflow-y: auto;
}

.hospital-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.hospital-card {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-lg);
    transition: all 0.2s;
    cursor: pointer;
}

.hospital-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary-light);
    transform: translateY(-2px);
}

.hospital-card.initial-message:hover {
    box-shadow: none;
    border-color: var(--color-border);
    transform: none;
    cursor: default;
}

.hospital-header {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.hospital-image {
    width: 80px;
    height: 80px;
    border-radius: var(--border-radius-lg);
    object-fit: cover;
    background: var(--color-surface);
}

.hospital-info {
    flex: 1;
}

.hospital-name-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-xs);
}

.hospital-name {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0;
}

.emergency-badge {
    background: var(--color-danger);
    color: white;
    padding: 4px var(--spacing-sm);
    border-radius: var(--border-radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
}

.hospital-rating {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-sm);
}

.rating-star {
    color: #fbbf24;
}

.rating-text {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.hospital-details {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-md);
}

.detail-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.detail-icon {
    color: var(--color-text-light);
}

.hospital-specialties {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-md);
}

.specialty-tag {
    padding: 4px var(--spacing-sm);
    background: var(--color-primary-lightest);
    color: var(--color-primary);
    border-radius: var(--border-radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
}

.hospital-actions {
    display: flex;
    gap: var(--spacing-sm);
}

.action-btn {
    flex: 1;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--border-radius-lg);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    text-decoration: none;
    text-align: center;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xs);
}

.btn-primary {
    background: var(--color-primary);
    color: white;
    border: none;
}

.btn-primary:hover {
    background: var(--color-primary-dark);
    color: white;
}

.btn-secondary {
    background: white;
    color: var(--color-text);
    border: 1px solid var(--color-border);
}

.btn-secondary:hover {
    background: var(--color-surface);
    color: var(--color-text);
}

.emergency-section {
    max-width: 1200px;
    margin: var(--spacing-xl) auto 0;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-lg);
}

.emergency-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-danger);
    margin: 0 0 var(--spacing-lg) 0;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.emergency-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-xl);
}

.checklist-section h4 {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0 0 var(--spacing-md) 0;
}

.checklist {
    list-style: none;
    padding: 0;
    margin: 0;
}

.checklist li {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
    padding-left: var(--spacing-md);
    position: relative;
}

.checklist li::before {
    content: "â€¢";
    color: var(--color-danger);
    font-weight: bold;
    position: absolute;
    left: 0;
}

.emergency-contacts {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.contact-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm);
    background: white;
    border-radius: var(--border-radius-md);
}

.contact-name {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
}

.contact-phone {
    font-size: var(--font-size-sm);
    color: var(--color-primary);
    font-weight: var(--font-weight-medium);
}

@media (max-width: 768px) {
    .hospital-main {
        flex-direction: column;
    }
    
    .search-controls {
        flex-direction: column;
    }
    
    .emergency-content {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .emergency-section {
        padding: 24px 20px;
    }
    
    .checklist-section {
        padding: 20px;
    }
    
    .favorite-hospital-card {
        padding: 16px;
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .favorite-hospital-info {
        margin-left: 8px;
        width: 100%;
    }
    
    .favorite-hospital-actions {
        align-self: flex-end;
        margin-top: 8px;
    }
    
    .hospital-actions {
        flex-direction: column;
    }
    
    .hospital-header {
        padding: var(--spacing-md);
    }
}

.action-btn.btn-primary {
    background: #fff !important;
    color: #3182f6 !important;
    border: 2px solid #3182f6 !important;
    font-weight: 700;
    border-radius: 999px;
    box-shadow: 0 2px 12px rgba(49,130,246,0.10);
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
}
.action-btn.btn-primary:hover,
.action-btn.btn-primary:focus {
    background: #3182f6 !important;
    color: #fff !important;
    border: 2px solid #2563c6 !important;
    box-shadow: 0 4px 18px rgba(49,130,246,0.13);
    outline: none;
}
.action-btn.btn-primary:active {
    background: #2563c6 !important;
    color: #fff !important;
    border: 2px solid #174ea6 !important;
    box-shadow: 0 2px 8px rgba(49,130,246,0.10);
}

.action-btn.btn-secondary {
    background: #fff !important;
    color: #3182f6 !important;
    border: 2px solid #3182f6 !important;
    font-weight: 700;
    border-radius: 999px;
    box-shadow: 0 2px 12px rgba(49,130,246,0.10);
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
}
.action-btn.btn-secondary:hover,
.action-btn.btn-secondary:focus {
    background: #3182f6 !important;
    color: #fff !important;
    border: 2px solid #2563c6 !important;
    box-shadow: 0 4px 18px rgba(49,130,246,0.13);
    outline: none;
}
.action-btn.btn-secondary:active {
    background: #2563c6 !important;
    color: #fff !important;
    border: 2px solid #174ea6 !important;
    box-shadow: 0 2px 8px rgba(49,130,246,0.10);
}

.hospital-main-narrow {
  max-width: 1000px;
  margin: 0 auto;
  width: 100%;
  padding: 32px 0 0 0;
}
.hospital-card-style {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  box-shadow: 0 2px 12px 0 rgb(0 0 0 / 4%);
  padding: 32px 32px 24px 32px;
  margin-bottom: 32px;
}
.hospital-search-section {
  margin: 0 0 32px 0;
  padding: 0;
}
.search-controls {
  display: flex;
  gap: 12px;
}
.search-box {
  flex: 1;
  position: relative;
}
.search-input {
  width: 100%;
  padding: 14px 16px 14px 44px;
  border: 1.5px solid #e5e7eb;
  border-radius: 12px;
  background: #fff;
  font-size: 16px;
  color: #222f3e;
}
.search-input::placeholder {
  color: #b0b8c1;
}
.search-icon {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: #b0b8c1;
  font-size: 20px;
}
.search-btn {
  min-width: 100px;
  padding: 12px 28px;
  border: 2px solid #3182f6;
  border-radius: 999px;
  background: transparent;
  color: #3182f6;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 2px 12px rgba(49,130,246,0.10);
  transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
  letter-spacing: 1px;
}
.search-btn:hover, .search-btn:focus {
  background: #3182f6;
  color: #fff;
  border: 2px solid #2563c6;
  box-shadow: 0 4px 18px rgba(49,130,246,0.13);
  outline: none;
}

.hospital-main {
  display: flex;
  gap: 32px;
  margin-bottom: 32px;
}
.map-section, .hospital-list-section {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  box-shadow: 0 2px 12px 0 rgb(0 0 0 / 4%);
  padding: 24px;
}
.map-section {
  flex: 1;
  min-width: 340px;
}
.hospital-list-section {
  flex: 1;
  min-width: 340px;
}
.map-header, .hospital-list-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}
.map-title, .hospital-list-title {
  font-size: 18px;
  font-weight: 600;
  color: #222f3e;
  margin: 0;
}
.emergency-section {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border: 1px solid #e2e8f0;
  border-radius: 20px;
  padding: 32px;
  margin-bottom: 32px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  position: relative;
}
.emergency-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #f59e0b, #ef4444);
  border-radius: 20px 20px 0 0;
}
.emergency-title {
  font-size: 20px;
  font-weight: 700;
  color: #1e293b;
  margin: 0 0 24px 0;
  display: flex;
  align-items: center;
  gap: 12px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.emergency-title i {
  font-size: 24px;
  color: #f59e0b;
}
.emergency-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 32px;
}
.checklist-section {
  background: white;
  padding: 24px;
  border-radius: 16px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}
.checklist-section h4 {
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
  margin: 0 0 16px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.checklist-section h4::before {
  content: '';
  width: 4px;
  height: 20px;
  background: linear-gradient(135deg, #f59e0b, #ef4444);
  border-radius: 2px;
}
.checklist {
  list-style: none;
  padding: 0;
  margin: 0;
}
.checklist li {
  font-size: 14px;
  color: #374151;
  margin-bottom: 10px;
  padding: 8px 16px 8px 32px;
  position: relative;
  background: #f8fafc;
  border-radius: 8px;
  border-left: 3px solid #cbd5e1;
  transition: all 0.2s;
}
.checklist li:hover {
  transform: translateX(2px);
  border-left-color: #f59e0b;
  background: #fef3c7;
}
.checklist li::before {
  content: "âš ï¸";
  position: absolute;
  left: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 12px;
}
.emergency-contacts {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.contact-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  background: none;
  border-radius: 8px;
}
.contact-name {
  font-size: 14px;
  font-weight: 500;
  color: #222f3e;
}
.contact-phone {
  font-size: 14px;
  color: #3182f6;
  font-weight: 600;
}

/* ì¦ê²¨ì°¾ê¸° ë³‘ì› ìŠ¤íƒ€ì¼ */
.favorite-hospitals-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  max-height: 280px;
  overflow-y: auto;
  padding-right: 8px;
}
.favorite-hospitals-grid::-webkit-scrollbar {
  width: 6px;
}
.favorite-hospitals-grid::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}
.favorite-hospitals-grid::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}
.favorite-hospitals-grid::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1;
}
.favorite-hospital-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border: 1px solid #e2e8f0;
  border-radius: 16px;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}
.favorite-hospital-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  transition: width 0.3s;
}
.favorite-hospital-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.12);
  border-color: #cbd5e1;
}
.favorite-hospital-card:hover::before {
  width: 6px;
}
.favorite-hospital-info {
  flex: 1;
  margin-left: 12px;
}
.favorite-hospital-name {
  font-size: 17px;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.favorite-hospital-name::before {
  content: "ğŸ¥";
  font-size: 16px;
}
.favorite-hospital-address {
  font-size: 13px;
  color: #64748b;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.favorite-hospital-address::before {
  content: "ğŸ“";
  font-size: 12px;
}
.favorite-hospital-phone {
  font-size: 14px;
  color: #3182f6;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}
.favorite-hospital-phone::before {
  content: "ğŸ“";
  font-size: 12px;
}
.favorite-hospital-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}
.favorite-action-btn {
  width: 40px;
  height: 40px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
  color: #64748b;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  text-decoration: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.favorite-action-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  color: #334155;
  text-decoration: none;
}
.favorite-action-btn:first-child {
  background: linear-gradient(135deg, #dbeafe, #bfdbfe);
  color: #3182f6;
}
.favorite-action-btn:first-child:hover {
  background: linear-gradient(135deg, #bfdbfe, #93c5fd);
  color: #1d4ed8;
}
.favorite-action-btn:last-child {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  color: #f59e0b;
}
.favorite-action-btn:last-child:hover {
  background: linear-gradient(135deg, #fde68a, #fcd34d);
  color: #d97706;
}
.no-favorites {
  text-align: center;
  padding: 32px 24px;
  color: #64748b;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 16px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.no-favorites i {
  display: block;
  margin-bottom: 16px;
  font-size: 32px;
  color: #cbd5e1;
}
.no-favorites p {
  margin: 6px 0;
  font-size: 14px;
  line-height: 1.5;
}
.no-favorites p:first-of-type {
  font-weight: 600;
  color: #475569;
  font-size: 16px;
}
.login-required {
  text-align: center;
  padding: 32px 24px;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 16px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.login-required p {
  margin: 0;
  font-size: 15px;
  color: #64748b;
  line-height: 1.5;
}
.login-required a {
  color: #3182f6;
  text-decoration: none;
  font-weight: 600;
  background: linear-gradient(135deg, #3182f6, #1d4ed8);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.login-required a:hover {
  text-decoration: underline;
}

/* ì¦ê²¨ì°¾ê¸° ë³„í‘œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.favorite-star-btn {
  width: 32px;
  height: 32px;
  border: none;
  border-radius: 50%;
  background: rgba(251, 191, 36, 0.1);
  color: #fbbf24;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  margin: 0;
}
.favorite-star-btn:hover {
  background: rgba(251, 191, 36, 0.2);
  transform: scale(1.1);
}
.favorite-star-btn.favorited {
  background: #fbbf24;
  color: white;
}
.favorite-star-btn.favorited:hover {
  background: #f59e0b;
}
.favorite-star-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}
</style>

<div class="hospital-main-narrow">
  <!-- ê²€ìƒ‰ ì¹´ë“œ -->
  <div class="hospital-search-section">
    <div class="search-controls">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" placeholder="ë³‘ì›ëª… ë˜ëŠ” ì£¼ì†Œë¡œ ê²€ìƒ‰..." value="{{ search_query|default:'' }}">
      </div>
      <button class="search-btn" onclick="performSearch()">
        <i class="fas fa-search"></i>
        ì¡°íšŒ
      </button>
    </div>
  </div>

  <!-- ì§€ë„/ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ -->
  <div class="hospital-main">
    <div class="map-section">
      <div class="map-header">
        <i class="fas fa-map-marker-alt" style="color: #3182f6;"></i>
        <h3 class="map-title">ì£¼ë³€ ë³‘ì› ì§€ë„</h3>
      </div>
      <div class="map-container" id="map" style="height:520px;"></div>
    </div>
    <div class="hospital-list-section">
      <div class="hospital-list-header">
        <i class="fas fa-hospital"></i>
        <h3 class="hospital-list-title">ë³‘ì› ë¦¬ìŠ¤íŠ¸</h3>
      </div>
      <div class="hospital-list">
        <!-- ê¸°ì¡´ ë³‘ì› ë¦¬ìŠ¤íŠ¸ ë‚´ìš© -->
        {% block hospital_list %}{% endblock %}
      </div>
    </div>
  </div>

  <!-- ì‘ê¸‰ ê°€ì´ë“œ ì¹´ë“œ -->
  <div class="emergency-section">
    <h3 class="emergency-title">
      <i class="fas fa-exclamation-triangle"></i>
      ì‘ê¸‰ìƒí™© ëŒ€ì‘ ê°€ì´ë“œ
    </h3>
    <div class="emergency-content">
      <div class="checklist-section">
        <h4>ì‘ê¸‰ ì¦ìƒ ì²´í¬ë¦¬ìŠ¤íŠ¸</h4>
        <ul class="checklist">
          <li>í˜¸í¡ê³¤ë€ ë˜ëŠ” ê³¼ë„í•œ í—ë–¡ì„</li>
          <li>ì˜ì‹ì„ ìƒê±°ë‚˜ ê²½ë ¨ ì¦ìƒ</li>
          <li>ì‹¬í•œ êµ¬í† ë‚˜ ì„¤ì‚¬ê°€ ì§€ì†ë¨</li>
          <li>ì™¸ìƒìœ¼ë¡œ ì¸í•œ ì¶œí˜ˆ</li>
          <li>ì¤‘ë… ì˜ì‹¬ ì¦ìƒ (êµ¬í† , ê²½ë ¨ ë“±)</li>
          <li>ì²´ì˜¨ì´ ê¸‰ê²©íˆ ì˜¤ë¥´ê±°ë‚˜ ë‚´ë ¤ê°</li>
        </ul>
      </div>
      <div class="checklist-section">
        <h4>ë‚˜ì˜ ì¦ê²¨ì°¾ê¸° ë³‘ì›</h4>
        {% if user.is_authenticated %}
          <div class="favorite-hospitals-table" id="favorite-hospitals-container">
            {% if favorite_hospitals %}
              <div class="favorite-hospitals-grid">
                {% for favorite in favorite_hospitals %}
                  <div class="favorite-hospital-card" data-hospital-id="{{ favorite.hospital.id }}">
                    <div class="favorite-hospital-info">
                      <div class="favorite-hospital-name">{{ favorite.hospital.name }}</div>
                      <div class="favorite-hospital-address">{{ favorite.hospital.address }}</div>
                      <div class="favorite-hospital-phone">{{ favorite.hospital.phone }}</div>
                    </div>
                    <div class="favorite-hospital-actions">
                      <a href="tel:{{ favorite.hospital.phone }}" class="favorite-action-btn">
                        <i class="fas fa-phone"></i>
                      </a>
                      <button class="favorite-action-btn remove-favorite" onclick="toggleFavorite({{ favorite.hospital.id }})" title="ì¦ê²¨ì°¾ê¸° í•´ì œ">
                        <i class="fas fa-star" style="color: #fbbf24;"></i>
                      </button>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="no-favorites">
                <i class="fas fa-star" style="color: #ccc; font-size: 24px; margin-bottom: 8px;"></i>
                <p>ì¦ê²¨ì°¾ê¸°í•œ ë³‘ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <p>ë³‘ì› ê²€ìƒ‰ í›„ ë³„í‘œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
              </div>
            {% endif %}
          </div>
        {% else %}
          <div class="login-required">
            <p>ì¦ê²¨ì°¾ê¸° ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ <a href="{% url 'common_app:login' %}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script id="hospital-data" type="application/json">
[
{% for hospital in hospitals %}
{
    "dbId": {{ hospital.id }},
    "name": "{{ hospital.name|escapejs }}",
    "lat": {{ hospital.latitude }},
    "lng": {{ hospital.longitude }},
    "address": "{{ hospital.address|escapejs }}",
    "phone": "{{ hospital.phone|escapejs }}",
    "distance": "{{ hospital.distance_km }}",
    "isEmergency": {{ hospital.is_emergency|yesno:"true,false" }},
    "rating": {{ hospital.rating }}
}{% if not forloop.last %},{% endif %}
{% endfor %}
]
</script>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=679cb0dcbdbd689c815830cfcb681150&libraries=services"></script>
<script>
function openDirections(address) {
    const encodedAddress = encodeURIComponent(address);
    window.open(`https://map.kakao.com/?q=${encodedAddress}`, '_blank');
}

const hospitals = JSON.parse(document.getElementById('hospital-data').textContent);
const isUserAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
const favoriteHospitalIds = {{ favorite_hospital_ids|safe }};

// ì¹´ì¹´ì˜¤ API ê²€ìƒ‰ ë³€ìˆ˜ë“¤
const ps = new kakao.maps.services.Places();
let markers = [];
let infowindow = new kakao.maps.InfoWindow({zIndex:1});
let searchResults = [];
let currentMap = null;
let userLocation = { lat: 37.5665, lng: 126.9780 }; // ê¸°ë³¸ê°’: ì„œìš¸ ì¤‘ì‹¬ë¶€

// ë§ˆì»¤ë¥¼ placeId(ë˜ëŠ” name+ì¢Œí‘œ)ë¡œ ë§¤í•‘
let markerMap = {};

// ê¸°ì¡´ ë§µ ì´ˆê¸°í™” í•¨ìˆ˜ ìˆ˜ì •
function initMap() {
    if (!window.kakao || !window.kakao.maps) return;
    const container = document.getElementById('map');
    if (!container) return;
    
    // ê¸°ë³¸ ì¤‘ì‹¬ì ì„ ì„œìš¸ë¡œ ì„¤ì •
    const center = new kakao.maps.LatLng(37.5665, 126.9780);
    currentMap = new kakao.maps.Map(container, {
        center: center,
        level: 6
    });
    
    // ì´ˆê¸° ìƒíƒœì—ì„œ ë³‘ì› ë¦¬ìŠ¤íŠ¸ì— ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
    showInitialMessage();
}

// ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜  
function showInitialMessage() {
    const hospitalListContainer = document.querySelector('.hospital-list');
    if (!hospitalListContainer) return;
    
    hospitalListContainer.innerHTML = `
        <div class="hospital-card initial-message">
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: var(--spacing-md); opacity: 0.3; color: #3182f6;"></i>
                <h4 style="margin-bottom: var(--spacing-sm); color: var(--color-text);">ë³‘ì›ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”</h4>
                <p style="margin-bottom: 0;">ë³‘ì›ëª…ì´ë‚˜ ì§€ì—­ëª…ì„ ì…ë ¥í•˜ì—¬</p>
                <p style="margin: 0;">ì£¼ë³€ ë™ë¬¼ë³‘ì›ì„ ì°¾ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    `;
}

// ë³‘ì› ë°ì´í„°ë¥¼ ì§€ë„ì™€ ë¦¬ìŠ¤íŠ¸ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function displayHospitals(hospitalData) {
    // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
    markers.forEach(m => m.setMap(null));
    markers = [];
    markerMap = {};
    infowindow.close();
    
    const bounds = new kakao.maps.LatLngBounds();
    
    hospitalData.forEach(function(hospital) {
        if (hospital.lat && hospital.lng) {
            const marker = new kakao.maps.Marker({
                map: currentMap,
                position: new kakao.maps.LatLng(hospital.lat, hospital.lng),
                title: hospital.name
            });
            markers.push(marker);
            
            // placeIdê°€ ìˆìœ¼ë©´ placeIdë¡œ, ì—†ìœ¼ë©´ name+lat+lngë¡œ ë§¤í•‘
            const key = hospital.placeId || (hospital.name + '_' + hospital.lat + '_' + hospital.lng);
            markerMap[key] = marker;

            kakao.maps.event.addListener(marker, 'click', function() {
                let content;
                
                // ê²€ìƒ‰ëœ ë³‘ì›ì¸ì§€ ê¸°ì¡´ ë³‘ì›ì¸ì§€ êµ¬ë¶„
                if (hospital.category && hospital.placeUrl) {
                    // ê²€ìƒ‰ëœ ë³‘ì› (ì¹´ì¹´ì˜¤ API ê²°ê³¼)
                    content = `
                      <div style="padding:10px; font-size:13px; min-width:220px;">
                        <div><b>ğŸ“ ${hospital.name}</b></div>
                        ${hospital.phone && hospital.phone !== 'ì •ë³´ ì—†ìŒ' ? `<div>ğŸ“ ${hospital.phone}</div>` : ''}
                        <div>ğŸ“« ${hospital.address}</div>
                        <div>ğŸ· ${hospital.category}</div>
                        <a href="${hospital.placeUrl}" target="_blank" style="color:#3182f6; text-decoration:underline;">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a>
                      </div>
                    `;
                } else {
                    // ê¸°ì¡´ ë³‘ì› (DB ë°ì´í„°)
                    content = `
                      <div style="padding:10px; font-size:13px; min-width:220px;">
                        <div><b>ğŸ“ ${hospital.name}</b></div>
                        ${hospital.phone && hospital.phone !== 'ì •ë³´ ì—†ìŒ' ? `<div>ğŸ“ ${hospital.phone}</div>` : ''}
                        <div>ğŸ“« ${hospital.address}</div>
                        <div>ğŸ· ë™ë¬¼ë³‘ì›</div>
                      </div>
                    `;
                }
                
                infowindow.setContent(content);
                infowindow.open(currentMap, marker);
            });
            
            bounds.extend(new kakao.maps.LatLng(hospital.lat, hospital.lng));
        }
    });
    
    if (hospitalData.length > 0 && hospitalData.some(h => h.lat && h.lng)) {
        currentMap.setBounds(bounds);
    }
    // ë³‘ì› ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    updateHospitalList(hospitalData);
}

// ì¹´ì¹´ì˜¤ API ê²€ìƒ‰ í•¨ìˆ˜
function searchAnimalHospitals(keyword) {
    if (!keyword.trim()) {
        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ë¹ˆ ìƒíƒœë¡œ ìœ ì§€
        markers.forEach(m => m.setMap(null));
        markers = [];
        infowindow.close();
        showInitialMessage();
        return;
    }
    
    const searchKeyword = keyword.trim() + ' ë™ë¬¼ë³‘ì›';
    
    // DB ë³‘ì›ì—ì„œ ë¨¼ì € ê²€ìƒ‰
    const dbResults = hospitals.filter(hospital => 
        hospital.name.toLowerCase().includes(keyword.toLowerCase()) ||
        hospital.address.toLowerCase().includes(keyword.toLowerCase())
    );
    
    console.log('DB ê²€ìƒ‰ ê²°ê³¼:', dbResults);
    
    // ì¹´ì¹´ì˜¤ API ê²€ìƒ‰
    ps.keywordSearch(searchKeyword, function(data, status, pagination) {
        let allResults = [...dbResults]; // DB ê²°ê³¼ë¥¼ ë¨¼ì € ì¶”ê°€
        
        if (status === kakao.maps.services.Status.OK) {
            console.log('ì¹´ì¹´ì˜¤ API ì‘ë‹µ ë°ì´í„°:', data); // ë””ë²„ê·¸ìš©
            
            // ë™ë¬¼ë³‘ì› ê´€ë ¨ í‚¤ì›Œë“œë¡œ í•„í„°ë§
            const keywords = ['ë™ë¬¼', 'ì• ì™„', 'ë°˜ë ¤', 'í«', 'ìº£', 'dog', 'cat', 'ê³ ì–‘ì´', 'ê°•ì•„ì§€'];
            const filtered = data.filter(place =>
                keywords.some(word => place.place_name.toLowerCase().includes(word))
            );
            
            // ê° ë³‘ì›ì— ëŒ€í•´ ì¶”ê°€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const promises = filtered.map(place => getHospitalDetails(place));
            
            Promise.all(promises).then(convertedResults => {
                // DB ê²°ê³¼ì™€ API ê²°ê³¼ í•©ì¹˜ê¸°
                allResults = [...dbResults, ...convertedResults];
                searchResults = allResults;
                displayHospitals(allResults);
                updateHospitalList(allResults);
            });
        } else {
            // ì¹´ì¹´ì˜¤ API ê²°ê³¼ê°€ ì—†ì–´ë„ DB ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            if (dbResults.length > 0) {
                searchResults = dbResults;
                displayHospitals(dbResults);
                updateHospitalList(dbResults);
            } else {
                // ì™„ì „íˆ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ë•Œë§Œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                const hospitalListContainer = document.querySelector('.hospital-list');
                if (hospitalListContainer) {
                    hospitalListContainer.innerHTML = `
                        <div class="hospital-card initial-message">
                            <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                                <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: var(--spacing-md); opacity: 0.3; color: #f59e0b;"></i>
                                <h4 style="margin-bottom: var(--spacing-sm); color: var(--color-text);">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                                <p style="margin-bottom: 0;">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.</p>
                                <p style="margin: 0;">ì˜ˆ: "ì„œìš¸ ë™ë¬¼ë³‘ì›", "ê°•ë‚¨êµ¬", "24ì‹œê°„" ë“±</p>
                            </div>
                        </div>
                    `;
                }
            }
        }
    });
}

// ë³‘ì› ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
async function getHospitalDetails(place) {
    // ê¸°ë³¸ ì •ë³´ë§Œ ì‚¬ìš©
    const hospitalInfo = {
        name: place.place_name,
        lat: parseFloat(place.y),
        lng: parseFloat(place.x),
        address: place.road_address_name || place.address_name,
        phone: place.phone || 'ì •ë³´ ì—†ìŒ',
        category: place.category_name,
        placeId: place.id,
        placeUrl: place.place_url
    };
    
    // ê±°ë¦¬ ê³„ì‚° (ì‚¬ìš©ì ìœ„ì¹˜ ê¸°ì¤€, ì—†ìœ¼ë©´ ì„œìš¸ ì¤‘ì‹¬ë¶€)
    const userLocation = getUserLocation();
    const userLat = userLocation.lat;
    const userLng = userLocation.lng;
    hospitalInfo.distance = calculateDistance(userLat, userLng, hospitalInfo.lat, hospitalInfo.lng);
    
    // ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ìœ¼ë¡œ ì‘ê¸‰ì‹¤ ì—¬ë¶€ë§Œ íŒë‹¨
    hospitalInfo.isEmergency = hospitalInfo.category && hospitalInfo.category.includes('24ì‹œ');
    
    return hospitalInfo;
}

// ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
function getUserLocation() {
    return userLocation;
}

// ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ ìš”ì²­
function requestUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation.lat = position.coords.latitude;
                userLocation.lng = position.coords.longitude;
                console.log('ì‚¬ìš©ì ìœ„ì¹˜ ì—…ë°ì´íŠ¸:', userLocation);
                
                // ì§€ë„ ì¤‘ì‹¬ì„ ì‚¬ìš©ì ìœ„ì¹˜ë¡œ ì´ë™
                if (currentMap) {
                    const center = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);
                    currentMap.setCenter(center);
                }
            },
            function(error) {
                console.log('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error.message);
                // ê¸°ë³¸ê°’ ìœ ì§€
            }
        );
    }
}

// ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (km ë‹¨ìœ„)
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // ì§€êµ¬ì˜ ë°˜ì§€ë¦„ (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return (R * c).toFixed(1);
}

// ì¡°íšŒ ë²„íŠ¼ í´ë¦­ í•¨ìˆ˜
function performSearch() {
    const searchInput = document.querySelector('.search-input');
    const searchValue = searchInput.value.trim();
    
    if (!searchValue) {
        alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        searchInput.focus();
        return;
    }
    
    searchAnimalHospitals(searchValue);
}

// ë³‘ì› ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ ì§€ë„ ì´ë™/ë§ˆì»¤ ê°•ì¡° (placeId ë§¤ì¹­)
function addHospitalListClickHandlers(hospitalData) {
  const cards = document.querySelectorAll('.hospital-card');
  cards.forEach((card, idx) => {
    card.addEventListener('click', function(e) {
      // ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ì§€ë„ ì´ë™í•˜ì§€ ì•ŠìŒ
      if (e.target.closest('.action-btn')) {
        return;
      }
      
      const lat = parseFloat(card.getAttribute('data-lat'));
      const lng = parseFloat(card.getAttribute('data-lng'));
      const placeId = card.getAttribute('data-place-id');
      const hospitalName = card.querySelector('.hospital-name').textContent;
      
      // ë§ˆì»¤ í‚¤ ìƒì„±
      let key = placeId;
      if (!key) {
        key = hospitalName + '_' + lat + '_' + lng;
      }
      
      const marker = markerMap[key];
      
      if (!isNaN(lat) && !isNaN(lng) && currentMap) {
        const moveLatLon = new kakao.maps.LatLng(lat, lng);
        
        // ì§€ë„ ì¤‘ì‹¬ ì´ë™ ë° í™•ëŒ€
        currentMap.panTo(moveLatLon);
        currentMap.setLevel(3);
        
        // ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ì •ë³´ì°½ í‘œì‹œ
        if (marker) {
          // í•´ë‹¹ ë³‘ì› ì •ë³´ ì°¾ê¸°
          const hospital = hospitalData[idx];
          if (hospital) {
            let content;
            
            // ê²€ìƒ‰ëœ ë³‘ì›ì¸ì§€ ê¸°ì¡´ ë³‘ì›ì¸ì§€ êµ¬ë¶„í•˜ì—¬ ì •ë³´ì°½ ë‚´ìš© ìƒì„±
            if (hospital.category && hospital.placeUrl) {
              // ê²€ìƒ‰ëœ ë³‘ì› (ì¹´ì¹´ì˜¤ API ê²°ê³¼)
              content = `
                <div style="padding:15px; font-size:14px; min-width:250px; line-height:1.4;">
                  <div style="font-weight:bold; font-size:16px; margin-bottom:8px; color:#222;">ğŸ“ ${hospital.name}</div>
                  ${hospital.phone && hospital.phone !== 'ì •ë³´ ì—†ìŒ' ? `<div style="margin-bottom:5px;">ğŸ“ ${hospital.phone}</div>` : ''}
                  <div style="margin-bottom:5px;">ğŸ“« ${hospital.address}</div>
                  <div style="margin-bottom:8px;">ğŸ· ${hospital.category}</div>
                  <div style="margin-bottom:5px;">ğŸ“ ê±°ë¦¬: ${hospital.distance}km</div>
                  <div style="margin-top:10px;">
                    <a href="${hospital.placeUrl}" target="_blank" style="color:#3182f6; text-decoration:underline; font-weight:500;">ì¹´ì¹´ì˜¤ë§µì—ì„œ ìì„¸íˆ ë³´ê¸°</a>
                  </div>
                </div>
              `;
            } else {
              // ê¸°ì¡´ ë³‘ì› (DB ë°ì´í„°)
              content = `
                <div style="padding:15px; font-size:14px; min-width:250px; line-height:1.4;">
                  <div style="font-weight:bold; font-size:16px; margin-bottom:8px; color:#222;">ğŸ“ ${hospital.name}</div>
                  ${hospital.phone && hospital.phone !== 'ì •ë³´ ì—†ìŒ' ? `<div style="margin-bottom:5px;">ğŸ“ ${hospital.phone}</div>` : ''}
                  <div style="margin-bottom:5px;">ğŸ“« ${hospital.address}</div>
                  <div style="margin-bottom:8px;">ğŸ· ë™ë¬¼ë³‘ì›</div>
                  <div style="margin-bottom:5px;">ğŸ“ ê±°ë¦¬: ${hospital.distance}km</div>
                </div>
              `;
            }
            
            infowindow.setContent(content);
            infowindow.open(currentMap, marker);
          }
        } else {
          console.log('ë§ˆì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', key);
        }
      }
      
      // ì¹´ë“œ ì„ íƒ íš¨ê³¼ (ì„ íƒì )
      cards.forEach(c => c.style.backgroundColor = '');
      card.style.backgroundColor = '#f8fafc';
      setTimeout(() => {
        card.style.backgroundColor = '';
      }, 2000);
    });
  });
}

// ë³‘ì› ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ìˆ˜ì •
function updateHospitalList(hospitalData) {
  const hospitalListContainer = document.querySelector('.hospital-list');
  if (!hospitalListContainer) return;

  if (hospitalData.length === 0) {
    hospitalListContainer.innerHTML = `
        <div class="hospital-card initial-message">
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: var(--spacing-md); opacity: 0.3;"></i>
                <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.</p>
            </div>
        </div>
    `;
    return;
  }

  let listHtml = '';
  hospitalData.forEach((hospital, idx) => {
    // ì‘ê¸‰ì‹¤ ë°°ì§€
    const emergencyBadge = hospital.isEmergency ? 
        '<span class="emergency-badge">ì‘ê¸‰</span>' : '';
    const placeIdAttr = hospital.placeId ? `data-place-id="${hospital.placeId}"` : '';
    
    // DB ë³‘ì›ì¸ì§€ í™•ì¸ (dbIdê°€ ìˆìœ¼ë©´ DB ë³‘ì›)
    const isDbHospital = hospital.dbId !== undefined;
    const isFavorited = isDbHospital && favoriteHospitalIds.includes(hospital.dbId);
    
    // ëª¨ë“  ë¡œê·¸ì¸ ì‚¬ìš©ìì—ê²Œ ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ í‘œì‹œ (DB ë³‘ì›ì€ ì‹¤ì œ ê¸°ëŠ¥, ê²€ìƒ‰ ë³‘ì›ì€ ìƒˆ í•¨ìˆ˜ ì‚¬ìš©)
    const favoriteButton = isUserAuthenticated ? 
        `<button class="favorite-star-btn ${isFavorited ? 'favorited' : ''}" onclick="${isDbHospital ? `toggleFavorite(${hospital.dbId}, this)` : `directAddToFavorites(${idx})`}" title="${isFavorited ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸°'}">
            <i class="fas fa-star"></i>
         </button>` : '';
         
    console.log('Hospital:', hospital.name, 'isDbHospital:', isDbHospital, 'isAuthenticated:', isUserAuthenticated, 'favoriteButton:', favoriteButton);
    
    listHtml += `
        <div class="hospital-card" data-lat="${hospital.lat}" data-lng="${hospital.lng}" ${placeIdAttr}>
            <div class="hospital-header">
                <div class="hospital-image">
                    <i class="fas fa-hospital" style="color: var(--color-text-light); font-size: 24px; display: flex; align-items: center; justify-content: center; height: 100%;"></i>
                </div>
                <div class="hospital-info">
                    <div class="hospital-name-row">
                        <h3 class="hospital-name">${hospital.name}</h3>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${emergencyBadge}
                            ${favoriteButton}
                        </div>
                    </div>
                    <div class="hospital-rating">
                        <span class="rating-text">${hospital.distance}km</span>
                    </div>
                    <div class="hospital-details">
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt detail-icon"></i>
                            <span>${hospital.address}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-phone detail-icon"></i>
                            <span>${hospital.phone}</span>
                        </div>
                    </div>
                    <div class="hospital-actions">
                        <a href="tel:${hospital.phone}" class="action-btn btn-primary">
                            <i class="fas fa-phone"></i>
                            ì „í™”í•˜ê¸°
                        </a>
                        <a href="#" class="action-btn btn-secondary" onclick="openDirections('${hospital.address}')">
                            <i class="fas fa-route"></i>
                            ê¸¸ì°¾ê¸°
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
  });

  hospitalListContainer.innerHTML = listHtml;
  
  // ë³‘ì› ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
  addHospitalListClickHandlers(hospitalData);
}

// ê²€ìƒ‰ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('.search-input');
    
    if (searchInput) {
        // Enter í‚¤ ê²€ìƒ‰
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
    }
    
    // ì¡°íšŒ ë²„íŠ¼ í•¨ìˆ˜ëŠ” ë³„ë„ë¡œ ì •ì˜ë¨
    
    // ë§µ ì´ˆê¸°í™” ë° ìœ„ì¹˜ ìš”ì²­
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            requestUserLocation();
        });
    } else {
        initMap();
        requestUserLocation();
    }
});

// ì¦ê²¨ì°¾ê¸° í† ê¸€ í•¨ìˆ˜
function toggleFavorite(hospitalId, buttonElement) {
    console.log('=== DEBUG: toggleFavorite START ===');
    console.log('hospitalId:', hospitalId);
    console.log('buttonElement:', buttonElement);
    
    if (!hospitalId) {
        console.log('ERROR: hospitalId is null/undefined');
        alert('ë³‘ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    const button = buttonElement || event.target.closest('.favorite-star-btn');
    console.log('button element:', button);
    
    if (button) {
        console.log('button attributes:');
        for (let attr of button.attributes) {
            console.log(`  ${attr.name}: ${attr.value}`);
        }
        button.disabled = true;
    }
    
    // ê²€ìƒ‰ëœ ë³‘ì›ì¸ì§€ í™•ì¸
    const isSearchHospital = button && button.hasAttribute('data-search-hospital');
    console.log('isSearchHospital:', isSearchHospital);
    console.log('has data-search-hospital attribute:', button ? button.hasAttribute('data-search-hospital') : 'no button');
    
    if (isSearchHospital) {
        console.log('Calling addSearchHospitalToFavorites...');
        // ê²€ìƒ‰ëœ ë³‘ì›ì„ DBì— ì¶”ê°€í•˜ê³  ì¦ê²¨ì°¾ê¸°
        addSearchHospitalToFavorites(hospitalId, button);
    } else {
        console.log('Calling toggleExistingHospitalFavorite...');
        // ê¸°ì¡´ DB ë³‘ì› ì¦ê²¨ì°¾ê¸° í† ê¸€
        toggleExistingHospitalFavorite(hospitalId, button);
    }
}

// ê¸°ì¡´ DB ë³‘ì› ì¦ê²¨ì°¾ê¸° í† ê¸€
function toggleExistingHospitalFavorite(hospitalId, button) {
    console.log('Calling toggleExistingHospitalFavorite with hospitalId:', hospitalId);
    console.log('URL will be:', `/emergency/favorite/${hospitalId}/`);
    
    fetch(`/emergency/favorite/${hospitalId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Success:', data);
        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (button) {
            if (data.is_favorite) {
                button.classList.add('favorited');
                button.title = 'ì¦ê²¨ì°¾ê¸° í•´ì œ';
                // favoriteHospitalIds ë°°ì—´ì— ì¶”ê°€
                if (!favoriteHospitalIds.includes(hospitalId)) {
                    favoriteHospitalIds.push(hospitalId);
                }
            } else {
                button.classList.remove('favorited');
                button.title = 'ì¦ê²¨ì°¾ê¸°';
                // favoriteHospitalIds ë°°ì—´ì—ì„œ ì œê±°
                const index = favoriteHospitalIds.indexOf(hospitalId);
                if (index > -1) {
                    favoriteHospitalIds.splice(index, 1);
                }
            }
            button.disabled = false;
        }
        
        // ì¦ê²¨ì°¾ê¸° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        updateFavoritesList();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì¦ê²¨ì°¾ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        if (button) {
            button.disabled = false;
        }
    });
}

// ê²€ìƒ‰ëœ ë³‘ì›ì„ DBì— ì¶”ê°€í•˜ê³  ì¦ê²¨ì°¾ê¸°
function addSearchHospitalToFavorites(hospitalId, button) {
    console.log('=== DEBUG: addSearchHospitalToFavorites START ===');
    console.log('hospitalId:', hospitalId);
    console.log('button:', button);
    console.log('Current URL:', window.location.href);
    console.log('Origin:', window.location.origin);
    
    // hospitalIdì—ì„œ ì¸ë±ìŠ¤ ì¶”ì¶œ (search_0, search_1, ...)
    const idx = hospitalId.replace('search_', '');
    console.log('extracted index:', idx);
    console.log('searchResults:', searchResults);
    console.log('searchResults length:', searchResults ? searchResults.length : 'undefined');
    
    const hospital = searchResults[parseInt(idx)];
    
    if (!hospital) {
        console.log('ERROR: ë³‘ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        console.log('Available searchResults indices:', Object.keys(searchResults || {}));
        alert('ë³‘ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        button.disabled = false;
        return;
    }
    
    console.log('Adding hospital to favorites:', hospital);
    console.log('Hospital details:', {
        name: hospital.name,
        address: hospital.address,
        phone: hospital.phone,
        lat: hospital.lat,
        lng: hospital.lng
    });
    
    const targetUrl = '/emergency/add-search-hospital/';
    console.log('Target URL:', targetUrl);
    console.log('Full URL:', window.location.origin + targetUrl);
    
    // í¼ ë°ì´í„° ìƒì„±
    const formData = new FormData();
    formData.append('name', hospital.name);
    formData.append('address', hospital.address);
    formData.append('phone', hospital.phone || 'ì •ë³´ ì—†ìŒ');
    formData.append('lat', hospital.lat);
    formData.append('lng', hospital.lng);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    console.log('FormData contents:');
    for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
    }
    
    console.log('About to send fetch request...');
    
    fetch(targetUrl, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('=== FETCH RESPONSE RECEIVED ===');
        console.log('Response status:', response.status);
        console.log('Response status text:', response.statusText);
        console.log('Response headers:', response.headers);
        console.log('Response URL:', response.url);
        console.log('Response OK:', response.ok);
        
        if (!response.ok) {
            return response.text().then(text => {
                console.log('=== ERROR RESPONSE BODY ===');
                console.log('Error response body:', text);
                console.log('=== ERROR RESPONSE BODY END ===');
                throw new Error(`HTTP error! status: ${response.status} - ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Search hospital added:', data);
        if (data.success) {
            // ë²„íŠ¼ì„ DB ë³‘ì› ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
            button.setAttribute('onclick', `toggleFavorite(${data.hospital_id}, this)`);
            button.removeAttribute('data-search-hospital');
            button.classList.add('favorited');
            button.title = 'ì¦ê²¨ì°¾ê¸° í•´ì œ';
            button.disabled = false;
            
            // favoriteHospitalIds ë°°ì—´ì— ì¶”ê°€
            if (!favoriteHospitalIds.includes(data.hospital_id)) {
                favoriteHospitalIds.push(data.hospital_id);
            }
            
            
            // ì¦ê²¨ì°¾ê¸° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            updateFavoritesList();
        } else {
            alert(data.message || 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì¦ê²¨ì°¾ê¸° ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        button.disabled = false;
    });
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ì¦ê²¨ì°¾ê¸° ëª©ë¡ ì—…ë°ì´íŠ¸
function updateFavoritesList() {
    fetch('/emergency/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.text())
    .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newFavorites = doc.querySelector('#favorite-hospitals-container');
        const currentFavorites = document.querySelector('#favorite-hospitals-container');
        
        if (newFavorites && currentFavorites) {
            currentFavorites.innerHTML = newFavorites.innerHTML;
        }
    })
    .catch(error => {
        console.error('Error updating favorites list:', error);
    });
}

// ì§ì ‘ ì¦ê²¨ì°¾ê¸° ì¶”ê°€ í•¨ìˆ˜ (ê²€ìƒ‰ëœ ë³‘ì›ìš©)
function directAddToFavorites(hospitalIdx) {
    console.log('=== DIRECT ADD TO FAVORITES ===');
    console.log('hospitalIdx:', hospitalIdx);
    console.log('searchResults:', searchResults);
    
    if (!searchResults || hospitalIdx >= searchResults.length) {
        alert('ë³‘ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const hospital = searchResults[hospitalIdx];
    console.log('Hospital to add:', hospital);
    
    if (!hospital.name || !hospital.address) {
        alert('ë³‘ì› ì •ë³´ê°€ ë¶ˆì™„ì „í•©ë‹ˆë‹¤.');
        return;
    }
    
    // AJAX ìš”ì²­ìœ¼ë¡œ ë³‘ì›ì„ DBì— ì¶”ê°€í•˜ê³  ì¦ê²¨ì°¾ê¸°
    const formData = new FormData();
    formData.append('name', hospital.name);
    formData.append('address', hospital.address);
    formData.append('phone', hospital.phone || 'ì •ë³´ ì—†ìŒ');
    formData.append('lat', hospital.lat || 0);
    formData.append('lng', hospital.lng || 0);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    console.log('Sending request to add hospital...');
    
    fetch('/emergency/add-search-hospital/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Success:', data);
        if (data.success) {
            
            // ì¦ê²¨ì°¾ê¸° ëª©ë¡ ì—…ë°ì´íŠ¸
            updateFavoritesList();
            
            // í•´ë‹¹ ë²„íŠ¼ ì°¾ì•„ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸
            const buttons = document.querySelectorAll('.favorite-star-btn');
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(`directAddToFavorites(${hospitalIdx})`)) {
                    btn.setAttribute('onclick', `toggleFavorite(${data.hospital_id}, this)`);
                    btn.classList.add('favorited');
                    btn.title = 'ì¦ê²¨ì°¾ê¸° í•´ì œ';
                }
            });
        } else {
            alert(data.message || 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì¦ê²¨ì°¾ê¸° ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    });
}

// í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
function testAddHospital() {
    console.log('=== TEST FUNCTION CALLED ===');
    alert('í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
    
    // í…ŒìŠ¤íŠ¸ìš© ë³‘ì› ë°ì´í„°
    const testHospital = {
        name: 'í…ŒìŠ¤íŠ¸ ë™ë¬¼ë³‘ì›',
        address: 'ì„œìš¸ì‹œ í…ŒìŠ¤íŠ¸êµ¬ í…ŒìŠ¤íŠ¸ë™',
        phone: '02-1234-5678',
        lat: 37.5665,
        lng: 126.9780
    };
    
    const formData = new FormData();
    formData.append('name', testHospital.name);
    formData.append('address', testHospital.address);
    formData.append('phone', testHospital.phone);
    formData.append('lat', testHospital.lat);
    formData.append('lng', testHospital.lng);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    console.log('Sending test request...');
    
    fetch('/emergency/add-search-hospital/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Success:', data);
        alert('í…ŒìŠ¤íŠ¸ ì„±ê³µ: ' + JSON.stringify(data));
    })
    .catch(error => {
        console.error('Error:', error);
        alert('í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
    });
}
</script>
{% endblock %} 