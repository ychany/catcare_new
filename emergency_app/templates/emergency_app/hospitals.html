{% extends 'common_app/base.html' %}
{% load static %}

{% block title %}ë³‘ì› ì°¾ê¸° - ëƒ¥ì´ ì§‘ì‚¬{% endblock %}

{% block content %}
<div class="weight-header">
  <div class="weight-nav">
    <div class="nav-left">
      <button class="back-btn" onclick="history.back()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <span class="weight-title">
        <i class="fas fa-hospital"></i>
        ë³‘ì›ì°¾ê¸°
      </span>
    </div>
  </div>
</div>

<style>
.weight-header {
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
  padding: 24px 0 16px 0;
}
.weight-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  max-width: 1200px;
  margin: 0 auto;
  margin-bottom: 0;
}
.nav-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.back-btn {
  background: none;
  border: none;
  font-size: 24px;
  color: #222f3e;
  cursor: pointer;
  padding: 4px;
  border-radius: 8px;
  transition: background-color 0.2s;
}
.back-btn:hover {
  background: #f3f4f6;
}
.weight-title {
  font-size: 24px;
  font-weight: 700;
  color: #222f3e;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.weight-title i {
  color: #222f3e;
  background: #f3f4f6;
  border-radius: 8px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}
.page-hide-nav {
    display: none !important;
}

/* Hide default header/nav */
.navbar, .nav-section, .header-section, .breadcrumb-section {
    display: none !important;
}

.main-container {
    padding: 0 !important;
    max-width: none !important;
    background: var(--color-background) !important;
}

/* Hospital finder specific styles */
.hospital-page {
    min-height: 100vh;
    background: var(--color-background);
    font-family: var(--font-primary);
}

.hospital-header {
    background: white;
    border-bottom: 1px solid var(--color-border);
    padding: var(--spacing-lg) var(--spacing-xl);
}

.hospital-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    margin-bottom: var(--spacing-lg);
}

.nav-left {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.back-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--color-text);
    cursor: pointer;
    padding: var(--spacing-xs);
    border-radius: var(--border-radius-md);
    transition: background-color 0.2s;
}

.back-btn:hover {
    background: var(--color-surface);
}

.hospital-title {
    font-size: 24px;
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0;
}

.nav-right {
    display: flex;
    gap: var(--spacing-sm);
}

.nav-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    color: var(--color-text);
    text-decoration: none;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    transition: all 0.2s;
}

.nav-btn:hover {
    background: var(--color-primary-light);
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.hospital-search-section {
    max-width: 1200px;
    margin: 0 auto;
}

.search-controls {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
}

.search-box {
    flex: 1;
    position: relative;
}

.search-input {
    width: 100%;
    padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) 48px;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    background: white;
    font-size: var(--font-size-md);
    color: var(--color-text);
}

.search-input::placeholder {
    color: var(--color-text-muted);
}

.search-icon {
    position: absolute;
    left: var(--spacing-md);
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    font-size: 20px;
}

.search-btn {
    min-width: 100px;
    padding: 10px 28px;
    border: 2px solid #3182f6;
    border-radius: 999px;
    background: #fff;
    color: #3182f6;
    font-size: 16px;
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 2px 12px rgba(49,130,246,0.10);
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    letter-spacing: 1px;
}
.search-btn:hover, .search-btn:focus {
    background: #3182f6;
    color: #fff;
    border: 2px solid #2563c6;
    box-shadow: 0 4px 18px rgba(49,130,246,0.13);
    outline: none;
}
.search-btn:active {
    background: #2563c6;
    color: #fff;
    border: 2px solid #174ea6;
    box-shadow: 0 2px 8px rgba(49,130,246,0.10);
}

.hospital-main {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    gap: var(--spacing-xl);
    min-height: 500px;
}

.map-section {
    flex: 1;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-lg);
}

.map-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
}

.map-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0;
}

.map-container {
    height: 400px;
    border-radius: var(--border-radius-lg);
    background: var(--color-surface);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: var(--spacing-md);
    color: var(--color-text-muted);
}

.map-placeholder-icon {
    font-size: 48px;
    opacity: 0.5;
}

.hospital-list-section {
    flex: 1;
    max-height: 600px;
    overflow-y: auto;
}

.hospital-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.hospital-card {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-lg);
    transition: all 0.2s;
}

.hospital-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary-light);
}

.hospital-header {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.hospital-image {
    width: 80px;
    height: 80px;
    border-radius: var(--border-radius-lg);
    object-fit: cover;
    background: var(--color-surface);
}

.hospital-info {
    flex: 1;
}

.hospital-name-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-xs);
}

.hospital-name {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0;
}

.emergency-badge {
    background: var(--color-danger);
    color: white;
    padding: 4px var(--spacing-sm);
    border-radius: var(--border-radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
}

.hospital-rating {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-sm);
}

.rating-star {
    color: #fbbf24;
}

.rating-text {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.hospital-details {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-md);
}

.detail-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.detail-icon {
    color: var(--color-text-light);
}

.hospital-specialties {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-md);
}

.specialty-tag {
    padding: 4px var(--spacing-sm);
    background: var(--color-primary-lightest);
    color: var(--color-primary);
    border-radius: var(--border-radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
}

.hospital-actions {
    display: flex;
    gap: var(--spacing-sm);
}

.action-btn {
    flex: 1;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--border-radius-lg);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    text-decoration: none;
    text-align: center;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xs);
}

.btn-primary {
    background: var(--color-primary);
    color: white;
    border: none;
}

.btn-primary:hover {
    background: var(--color-primary-dark);
    color: white;
}

.btn-secondary {
    background: white;
    color: var(--color-text);
    border: 1px solid var(--color-border);
}

.btn-secondary:hover {
    background: var(--color-surface);
    color: var(--color-text);
}

.emergency-section {
    max-width: 1200px;
    margin: var(--spacing-xl) auto 0;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-lg);
}

.emergency-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-danger);
    margin: 0 0 var(--spacing-lg) 0;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.emergency-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-xl);
}

.checklist-section h4 {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    margin: 0 0 var(--spacing-md) 0;
}

.checklist {
    list-style: none;
    padding: 0;
    margin: 0;
}

.checklist li {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
    padding-left: var(--spacing-md);
    position: relative;
}

.checklist li::before {
    content: "â€¢";
    color: var(--color-danger);
    font-weight: bold;
    position: absolute;
    left: 0;
}

.emergency-contacts {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.contact-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm);
    background: white;
    border-radius: var(--border-radius-md);
}

.contact-name {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
}

.contact-phone {
    font-size: var(--font-size-sm);
    color: var(--color-primary);
    font-weight: var(--font-weight-medium);
}

@media (max-width: 768px) {
    .hospital-main {
        flex-direction: column;
    }
    
    .search-controls {
        flex-direction: column;
    }
    
    .emergency-content {
        grid-template-columns: 1fr;
    }
    
    .hospital-actions {
        flex-direction: column;
    }
    
    .hospital-header {
        padding: var(--spacing-md);
    }
}

.action-btn.btn-primary {
    background: #fff !important;
    color: #3182f6 !important;
    border: 2px solid #3182f6 !important;
    font-weight: 700;
    border-radius: 999px;
    box-shadow: 0 2px 12px rgba(49,130,246,0.10);
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
}
.action-btn.btn-primary:hover,
.action-btn.btn-primary:focus {
    background: #3182f6 !important;
    color: #fff !important;
    border: 2px solid #2563c6 !important;
    box-shadow: 0 4px 18px rgba(49,130,246,0.13);
    outline: none;
}
.action-btn.btn-primary:active {
    background: #2563c6 !important;
    color: #fff !important;
    border: 2px solid #174ea6 !important;
    box-shadow: 0 2px 8px rgba(49,130,246,0.10);
}

.action-btn.btn-secondary {
    background: #fff !important;
    color: #3182f6 !important;
    border: 2px solid #3182f6 !important;
    font-weight: 700;
    border-radius: 999px;
    box-shadow: 0 2px 12px rgba(49,130,246,0.10);
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
}
.action-btn.btn-secondary:hover,
.action-btn.btn-secondary:focus {
    background: #3182f6 !important;
    color: #fff !important;
    border: 2px solid #2563c6 !important;
    box-shadow: 0 4px 18px rgba(49,130,246,0.13);
    outline: none;
}
.action-btn.btn-secondary:active {
    background: #2563c6 !important;
    color: #fff !important;
    border: 2px solid #174ea6 !important;
    box-shadow: 0 2px 8px rgba(49,130,246,0.10);
}

.hospital-main-narrow {
  max-width: 1000px;
  margin: 0 auto;
  width: 100%;
  padding: 32px 0 0 0;
}
.hospital-card-style {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  box-shadow: 0 2px 12px 0 rgb(0 0 0 / 4%);
  padding: 32px 32px 24px 32px;
  margin-bottom: 32px;
}
.hospital-search-section {
  margin: 0 0 32px 0;
  padding: 0;
}
.search-controls {
  display: flex;
  gap: 12px;
}
.search-box {
  flex: 1;
  position: relative;
}
.search-input {
  width: 100%;
  padding: 14px 16px 14px 44px;
  border: 1.5px solid #e5e7eb;
  border-radius: 12px;
  background: #f9fafb;
  font-size: 16px;
  color: #222f3e;
}
.search-input::placeholder {
  color: #b0b8c1;
}
.search-icon {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: #b0b8c1;
  font-size: 20px;
}
.search-btn {
  min-width: 100px;
  padding: 12px 28px;
  border: 2px solid #3182f6;
  border-radius: 999px;
  background: #fff;
  color: #3182f6;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 2px 12px rgba(49,130,246,0.10);
  transition: background 0.18s, color 0.18s, box-shadow 0.18s, border 0.18s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
  letter-spacing: 1px;
}
.search-btn:hover, .search-btn:focus {
  background: #3182f6;
  color: #fff;
  border: 2px solid #2563c6;
  box-shadow: 0 4px 18px rgba(49,130,246,0.13);
  outline: none;
}

.hospital-main {
  display: flex;
  gap: 32px;
  margin-bottom: 32px;
}
.map-section, .hospital-list-section {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  box-shadow: 0 2px 12px 0 rgb(0 0 0 / 4%);
  padding: 24px;
}
.map-section {
  flex: 1;
  min-width: 340px;
}
.hospital-list-section {
  flex: 1;
  min-width: 340px;
}
.map-header, .hospital-list-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}
.map-title, .hospital-list-title {
  font-size: 18px;
  font-weight: 600;
  color: #222f3e;
  margin: 0;
}
.emergency-section {
  background: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 16px;
  padding: 24px 32px;
  margin-bottom: 32px;
}
.emergency-title {
  font-size: 18px;
  font-weight: 700;
  color: #e53e3e;
  margin: 0 0 16px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.checklist-section h4 {
  font-size: 16px;
  font-weight: 600;
  color: #222f3e;
  margin: 0 0 12px 0;
}
.checklist {
  list-style: none;
  padding: 0;
  margin: 0 0 12px 0;
}
.checklist li {
  font-size: 14px;
  color: #e53e3e;
  margin-bottom: 6px;
  padding-left: 16px;
  position: relative;
}
.checklist li::before {
  content: "â€¢";
  color: #e53e3e;
  font-weight: bold;
  position: absolute;
  left: 0;
}
.emergency-contacts {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.contact-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  background: none;
  border-radius: 8px;
}
.contact-name {
  font-size: 14px;
  font-weight: 500;
  color: #222f3e;
}
.contact-phone {
  font-size: 14px;
  color: #3182f6;
  font-weight: 600;
}
</style>

<div class="hospital-main-narrow">
  <!-- ê²€ìƒ‰ ì¹´ë“œ -->
  <div class="hospital-card-style hospital-search-section">
    <div class="search-controls">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" placeholder="ë³‘ì›ëª… ë˜ëŠ” ì£¼ì†Œë¡œ ê²€ìƒ‰..." value="{{ search_query|default:'' }}">
      </div>
      <button class="search-btn" onclick="performSearch()">
        <i class="fas fa-search"></i>
        ì¡°íšŒ
      </button>
    </div>
  </div>

  <!-- ì§€ë„/ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ -->
  <div class="hospital-main">
    <div class="map-section">
      <div class="map-header">
        <i class="fas fa-map-marker-alt" style="color: #3182f6;"></i>
        <h3 class="map-title">ì£¼ë³€ ë³‘ì› ì§€ë„</h3>
      </div>
      <div class="map-container" id="map" style="height:400px;"></div>
    </div>
    <div class="hospital-list-section">
      <div class="hospital-list-header">
        <i class="fas fa-hospital"></i>
        <h3 class="hospital-list-title">ë³‘ì› ë¦¬ìŠ¤íŠ¸</h3>
      </div>
      <div class="hospital-list">
        <!-- ê¸°ì¡´ ë³‘ì› ë¦¬ìŠ¤íŠ¸ ë‚´ìš© -->
        {% block hospital_list %}{% endblock %}
      </div>
    </div>
  </div>

  <!-- ì‘ê¸‰ ê°€ì´ë“œ ì¹´ë“œ -->
  <div class="emergency-section">
    <h3 class="emergency-title">
      <i class="fas fa-exclamation-triangle"></i>
      ì‘ê¸‰ìƒí™© ëŒ€ì‘ ê°€ì´ë“œ
    </h3>
    <div class="emergency-content">
      <div class="checklist-section">
        <h4>ì‘ê¸‰ ì¦ìƒ ì²´í¬ë¦¬ìŠ¤íŠ¸</h4>
        <ul class="checklist">
          <li>í˜¸í¡ê³¤ë€ ë˜ëŠ” ê³¼ë„í•œ í—ë–¡ì„</li>
          <li>ì˜ì‹ì„ ìƒê±°ë‚˜ ê²½ë ¨ ì¦ìƒ</li>
          <li>ì‹¬í•œ êµ¬í† ë‚˜ ì„¤ì‚¬ê°€ ì§€ì†ë¨</li>
          <li>ì™¸ìƒìœ¼ë¡œ ì¸í•œ ì¶œí˜ˆ</li>
          <li>ì¤‘ë… ì˜ì‹¬ ì¦ìƒ (êµ¬í† , ê²½ë ¨ ë“±)</li>
          <li>ì²´ì˜¨ì´ ê¸‰ê²©íˆ ì˜¤ë¥´ê±°ë‚˜ ë‚´ë ¤ê°</li>
        </ul>
      </div>
      <div class="checklist-section">
        <h4>24ì‹œê°„ ì‘ê¸‰ ì—°ë½ì²˜</h4>
        <div class="emergency-contacts">
          <div class="contact-item">
            <span class="contact-name">24ì‹œ ìš°ë¦¬ë™ë¬¼ë³‘ì›</span>
            <span class="contact-phone">02-1234-5678</span>
          </div>
          <div class="contact-item">
            <span class="contact-name">ì‘ê¸‰ë™ë¬¼ì˜ë£Œì„¼í„°</span>
            <span class="contact-phone">02-4567-8901</span>
          </div>
          <div class="contact-item">
            <span class="contact-name">ì•¼ê°„ì‘ê¸‰ë™ë¬¼ë³‘ì›</span>
            <span class="contact-phone">02-7890-1234</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script id="hospital-data" type="application/json">
[]
</script>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=679cb0dcbdbd689c815830cfcb681150&libraries=services"></script>
<script>
function openDirections(address) {
    const encodedAddress = encodeURIComponent(address);
    window.open(`https://map.kakao.com/?q=${encodedAddress}`, '_blank');
}

const hospitals = JSON.parse(document.getElementById('hospital-data').textContent);

// ì¹´ì¹´ì˜¤ API ê²€ìƒ‰ ë³€ìˆ˜ë“¤
const ps = new kakao.maps.services.Places();
let markers = [];
let infowindow = new kakao.maps.InfoWindow({zIndex:1});
let searchResults = [];
let currentMap = null;
let userLocation = { lat: 37.5665, lng: 126.9780 }; // ê¸°ë³¸ê°’: ì„œìš¸ ì¤‘ì‹¬ë¶€

// ë§ˆì»¤ë¥¼ placeId(ë˜ëŠ” name+ì¢Œí‘œ)ë¡œ ë§¤í•‘
let markerMap = {};

// ê¸°ì¡´ ë§µ ì´ˆê¸°í™” í•¨ìˆ˜ ìˆ˜ì •
function initMap() {
    if (!window.kakao || !window.kakao.maps) return;
    const container = document.getElementById('map');
    if (!container) return;
    
    // ê¸°ë³¸ ì¤‘ì‹¬ì ì„ ì„œìš¸ë¡œ ì„¤ì •
    const center = new kakao.maps.LatLng(37.5665, 126.9780);
    currentMap = new kakao.maps.Map(container, {
        center: center,
        level: 6
    });
    
    // ì²˜ìŒì—ëŠ” ë¹ˆ ì§€ë„ë§Œ í‘œì‹œ (ê¸°ì¡´ ë³‘ì› ë°ì´í„° í‘œì‹œí•˜ì§€ ì•ŠìŒ)
}

// ë³‘ì› ë°ì´í„°ë¥¼ ì§€ë„ì™€ ë¦¬ìŠ¤íŠ¸ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function displayHospitals(hospitalData) {
    // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
    markers.forEach(m => m.setMap(null));
    markers = [];
    markerMap = {};
    infowindow.close();
    
    const bounds = new kakao.maps.LatLngBounds();
    
    hospitalData.forEach(function(hospital) {
        if (hospital.lat && hospital.lng) {
            const marker = new kakao.maps.Marker({
                map: currentMap,
                position: new kakao.maps.LatLng(hospital.lat, hospital.lng),
                title: hospital.name
            });
            markers.push(marker);
            
            // placeIdê°€ ìˆìœ¼ë©´ placeIdë¡œ, ì—†ìœ¼ë©´ name+lat+lngë¡œ ë§¤í•‘
            const key = hospital.placeId || (hospital.name + '_' + hospital.lat + '_' + hospital.lng);
            markerMap[key] = marker;

            kakao.maps.event.addListener(marker, 'click', function() {
                let content;
                
                // ê²€ìƒ‰ëœ ë³‘ì›ì¸ì§€ ê¸°ì¡´ ë³‘ì›ì¸ì§€ êµ¬ë¶„
                if (hospital.category && hospital.placeUrl) {
                    // ê²€ìƒ‰ëœ ë³‘ì› (ì¹´ì¹´ì˜¤ API ê²°ê³¼)
                    content = `
                      <div style="padding:10px; font-size:13px; min-width:220px;">
                        <div><b>ğŸ“ ${hospital.name}</b></div>
                        ${hospital.phone && hospital.phone !== 'ì •ë³´ ì—†ìŒ' ? `<div>ğŸ“ ${hospital.phone}</div>` : ''}
                        <div>ğŸ“« ${hospital.address}</div>
                        <div>ğŸ· ${hospital.category}</div>
                        <a href="${hospital.placeUrl}" target="_blank" style="color:#3182f6; text-decoration:underline;">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a>
                      </div>
                    `;
                } else {
                    // ê¸°ì¡´ ë³‘ì› (DB ë°ì´í„°)
                    content = `
                      <div style="padding:10px; font-size:13px; min-width:220px;">
                        <div><b>ğŸ“ ${hospital.name}</b></div>
                        ${hospital.phone && hospital.phone !== 'ì •ë³´ ì—†ìŒ' ? `<div>ğŸ“ ${hospital.phone}</div>` : ''}
                        <div>ğŸ“« ${hospital.address}</div>
                        <div>ğŸ· ë™ë¬¼ë³‘ì›</div>
                      </div>
                    `;
                }
                
                infowindow.setContent(content);
                infowindow.open(currentMap, marker);
            });
            
            bounds.extend(new kakao.maps.LatLng(hospital.lat, hospital.lng));
        }
    });
    
    if (hospitalData.length > 0 && hospitalData.some(h => h.lat && h.lng)) {
        currentMap.setBounds(bounds);
    }
    // ë³‘ì› ë¦¬ìŠ¤íŠ¸ì™€ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©ì„ ë§ˆì»¤ ìƒì„± í›„ì—ë§Œ ì‹¤í–‰
    updateHospitalList(hospitalData);
    addHospitalListClickHandlers(hospitalData);
}

// ì¹´ì¹´ì˜¤ API ê²€ìƒ‰ í•¨ìˆ˜
function searchAnimalHospitals(keyword) {
    if (!keyword.trim()) {
        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ë¹ˆ ìƒíƒœë¡œ ìœ ì§€
        markers.forEach(m => m.setMap(null));
        markers = [];
        infowindow.close();
        updateHospitalList([]);
        return;
    }
    
    const searchKeyword = keyword.trim() + ' ë™ë¬¼ë³‘ì›';
    ps.keywordSearch(searchKeyword, function(data, status, pagination) {
        if (status === kakao.maps.services.Status.OK) {
            console.log('ì¹´ì¹´ì˜¤ API ì‘ë‹µ ë°ì´í„°:', data); // ë””ë²„ê·¸ìš©
            
            // ë™ë¬¼ë³‘ì› ê´€ë ¨ í‚¤ì›Œë“œë¡œ í•„í„°ë§
            const keywords = ['ë™ë¬¼', 'ì• ì™„', 'ë°˜ë ¤', 'í«', 'ìº£', 'dog', 'cat', 'ê³ ì–‘ì´', 'ê°•ì•„ì§€'];
            const filtered = data.filter(place =>
                keywords.some(word => place.place_name.toLowerCase().includes(word))
            );
            
            // ê° ë³‘ì›ì— ëŒ€í•´ ì¶”ê°€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const promises = filtered.map(place => getHospitalDetails(place));
            
            Promise.all(promises).then(convertedResults => {
                searchResults = convertedResults;
                displayHospitals(convertedResults);
                updateHospitalList(convertedResults);
            });
        } else {
            alert('ë™ë¬¼ë³‘ì›ì´ ê²€ìƒ‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            // ê²€ìƒ‰ ì‹¤íŒ¨ì‹œ ë¹ˆ ìƒíƒœ ìœ ì§€
            updateHospitalList([]);
        }
    });
}

// ë³‘ì› ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
async function getHospitalDetails(place) {
    // ê¸°ë³¸ ì •ë³´ë§Œ ì‚¬ìš©
    const hospitalInfo = {
        name: place.place_name,
        lat: parseFloat(place.y),
        lng: parseFloat(place.x),
        address: place.road_address_name || place.address_name,
        phone: place.phone || 'ì •ë³´ ì—†ìŒ',
        category: place.category_name,
        placeId: place.id,
        placeUrl: place.place_url
    };
    
    // ê±°ë¦¬ ê³„ì‚° (ì‚¬ìš©ì ìœ„ì¹˜ ê¸°ì¤€, ì—†ìœ¼ë©´ ì„œìš¸ ì¤‘ì‹¬ë¶€)
    const userLocation = getUserLocation();
    const userLat = userLocation.lat;
    const userLng = userLocation.lng;
    hospitalInfo.distance = calculateDistance(userLat, userLng, hospitalInfo.lat, hospitalInfo.lng);
    
    // ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ìœ¼ë¡œ ì‘ê¸‰ì‹¤ ì—¬ë¶€ë§Œ íŒë‹¨
    hospitalInfo.isEmergency = hospitalInfo.category && hospitalInfo.category.includes('24ì‹œ');
    
    return hospitalInfo;
}

// ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
function getUserLocation() {
    return userLocation;
}

// ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ ìš”ì²­
function requestUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation.lat = position.coords.latitude;
                userLocation.lng = position.coords.longitude;
                console.log('ì‚¬ìš©ì ìœ„ì¹˜ ì—…ë°ì´íŠ¸:', userLocation);
                
                // ì§€ë„ ì¤‘ì‹¬ì„ ì‚¬ìš©ì ìœ„ì¹˜ë¡œ ì´ë™
                if (currentMap) {
                    const center = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);
                    currentMap.setCenter(center);
                }
            },
            function(error) {
                console.log('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error.message);
                // ê¸°ë³¸ê°’ ìœ ì§€
            }
        );
    }
}

// ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (km ë‹¨ìœ„)
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // ì§€êµ¬ì˜ ë°˜ì§€ë¦„ (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return (R * c).toFixed(1);
}

// ì¡°íšŒ ë²„íŠ¼ í´ë¦­ í•¨ìˆ˜
function performSearch() {
    const searchInput = document.querySelector('.search-input');
    const searchValue = searchInput.value.trim();
    
    if (!searchValue) {
        alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        searchInput.focus();
        return;
    }
    
    searchAnimalHospitals(searchValue);
}

// ë³‘ì› ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ ì§€ë„ ì´ë™/ë§ˆì»¤ ê°•ì¡° (placeId ë§¤ì¹­)
function addHospitalListClickHandlers(hospitalData) {
  const cards = document.querySelectorAll('.hospital-card');
  cards.forEach((card, idx) => {
    card.addEventListener('click', function() {
      const lat = parseFloat(card.getAttribute('data-lat'));
      const lng = parseFloat(card.getAttribute('data-lng'));
      const placeId = card.getAttribute('data-place-id');
      let key = placeId;
      if (!key) {
        key = card.querySelector('.hospital-name').textContent + '_' + lat + '_' + lng;
      }
      const marker = markerMap[key];
      if (!isNaN(lat) && !isNaN(lng) && currentMap && marker) {
        const moveLatLon = new kakao.maps.LatLng(lat, lng);
        currentMap.panTo(moveLatLon);
        currentMap.setLevel(3);
        infowindow.open(currentMap, marker);
      }
    });
  });
}

// ë³‘ì› ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ìˆ˜ì • (data-place-id ì¶”ê°€)
function updateHospitalList(hospitalData) {
  const hospitalListContainer = document.querySelector('.hospital-list');
  if (!hospitalListContainer) return;

  if (hospitalData.length === 0) {
    hospitalListContainer.innerHTML = `
        <div class="hospital-card">
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: var(--spacing-md); opacity: 0.3;"></i>
                <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.</p>
            </div>
        </div>
    `;
    return;
  }

  let listHtml = '';
  hospitalData.forEach((hospital, idx) => {
    // ì‘ê¸‰ì‹¤ ë°°ì§€
    const emergencyBadge = hospital.isEmergency ? 
        '<span class="emergency-badge">ì‘ê¸‰</span>' : '';
    const placeIdAttr = hospital.placeId ? `data-place-id="${hospital.placeId}"` : '';
    listHtml += `
        <div class="hospital-card" data-lat="${hospital.lat}" data-lng="${hospital.lng}" ${placeIdAttr}>
            <div class="hospital-header">
                <div class="hospital-image">
                    <i class="fas fa-hospital" style="color: var(--color-text-light); font-size: 24px; display: flex; align-items: center; justify-content: center; height: 100%;"></i>
                </div>
                <div class="hospital-info">
                    <div class="hospital-name-row">
                        <h3 class="hospital-name">${hospital.name}</h3>
                        ${emergencyBadge}
                    </div>
                    <div class="hospital-rating">
                        <span class="rating-text">${hospital.distance}km</span>
                    </div>
                    <div class="hospital-details">
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt detail-icon"></i>
                            <span>${hospital.address}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-phone detail-icon"></i>
                            <span>${hospital.phone}</span>
                        </div>
                    </div>
                    <div class="hospital-actions">
                        <a href="tel:${hospital.phone}" class="action-btn btn-primary">
                            <i class="fas fa-phone"></i>
                            ì „í™”í•˜ê¸°
                        </a>
                        <a href="#" class="action-btn btn-secondary" onclick="openDirections('${hospital.address}')">
                            <i class="fas fa-route"></i>
                            ê¸¸ì°¾ê¸°
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
  });

  hospitalListContainer.innerHTML = listHtml;
  // addHospitalListClickHandlersëŠ” ì—¬ê¸°ì„œ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
}

// ê²€ìƒ‰ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('.search-input');
    
    if (searchInput) {
        // Enter í‚¤ ê²€ìƒ‰
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
        
        // ì‹¤ì‹œê°„ ê²€ìƒ‰ (ì˜µì…˜)
        let searchTimeout;
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const searchValue = this.value.trim();
            
            if (searchValue === '') {
                // ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ìˆìœ¼ë©´ ë¹ˆ ìƒíƒœë¡œ ìœ ì§€
                markers.forEach(m => m.setMap(null));
                markers = [];
                infowindow.close();
                updateHospitalList([]);
                return;
            }
            
            // 500ms í›„ì— ê²€ìƒ‰ ì‹¤í–‰ (ë””ë°”ìš´ì‹±)
            searchTimeout = setTimeout(() => {
                if (searchValue.length >= 2) {
                    searchAnimalHospitals(searchValue);
                }
            }, 500);
        });
    }
    
    // ì¡°íšŒ ë²„íŠ¼ í•¨ìˆ˜ëŠ” ë³„ë„ë¡œ ì •ì˜ë¨
    
    // ë§µ ì´ˆê¸°í™” ë° ìœ„ì¹˜ ìš”ì²­
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            requestUserLocation();
        });
    } else {
        initMap();
        requestUserLocation();
    }
});
</script>
{% endblock %} 