{% extends 'common_app/base.html' %}
{% load static %}

{% block title %}체중관리 - 냥이 집사{% endblock %}

{% block content %}
<style>
/* food/medical 스타일 가이드 적용 - 색상, 카드, 버튼, 입력창, 폰트, radius, 여백 등 */
.weight-page {
    min-height: 100vh;
    background: var(--bg-primary);
    font-family: var(--font-primary);
}
.weight-header {
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-light);
    padding: var(--spacing-lg) var(--spacing-xl);
}
.weight-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    margin-bottom: var(--spacing-lg);
}
.nav-left {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}
.back-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-primary);
    cursor: pointer;
    padding: var(--spacing-xs);
    border-radius: var(--radius-md);
    transition: background-color 0.2s;
}
.back-btn:hover {
    background: var(--bg-tertiary);
}
.weight-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}
.nav-right {
    display: flex;
    gap: var(--spacing-sm);
}
.nav-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}
.nav-btn:hover {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: var(--white);
}
.weight-main {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--spacing-xl);
}
.stats-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}
.stat-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    text-align: center;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-sm);
}
.stat-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--primary-color);
}
.stat-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 20px;
    margin-bottom: var(--spacing-xs);
}
.stat-value, .stat-number {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
}
.stat-label {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
}
.dashboard-grid {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
}
.dashboard-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    overflow: hidden;
}
.card-header {
    background: var(--bg-tertiary);
    padding: var(--spacing-xl);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.card-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}
.card-title i {
    color: var(--primary-color);
}
.card-content {
    padding: var(--spacing-xl);
}
.weight-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}
.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
}
.form-label {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}
.form-label i {
    color: var(--primary-color);
    width: 16px;
}
.form-input {
    padding: var(--spacing-md);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    font-size: 16px;
    background: var(--bg-primary);
    color: var(--text-primary);
}
.form-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
}
.btn-submit {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: var(--spacing-md) var(--spacing-xl);
    border-radius: var(--radius-lg);
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-sm);
}
.btn-submit:hover {
    background: #e55a2b !important;
    color: #fff !important;
    transform: translateY(-2px);
}
.btn-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}
.chart-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}
.chart-filter {
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    font-size: 14px;
    background: var(--bg-primary);
    color: var(--text-primary);
}
.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: var(--spacing-lg);
}
.chart-legend {
    display: flex;
    justify-content: center;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 14px;
    color: var(--text-primary);
}
.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}
.records-section {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    overflow: hidden;
}
.section-header {
    background: var(--bg-tertiary);
    padding: var(--spacing-xl);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.section-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}
.section-title i {
    color: var(--primary-color);
}
.section-filters {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}
.filter-select {
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    font-size: 14px;
    background: var(--bg-primary);
    color: var(--text-primary);
}
.filter-info {
    font-size: 14px;
    color: var(--text-secondary);
}
.records-container {
    padding: var(--spacing-xl);
}
.records-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--spacing-lg);
}
.record-item {
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    border-left: 4px solid var(--primary-color);
    transition: all 0.2s;
}
.record-item:hover {
    background: #f0f0f0;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}
.record-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}
.record-pet {
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}
.record-date {
    color: var(--text-secondary);
    font-size: 14px;
}
.record-weight {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: var(--spacing-xs);
}
.record-change {
    font-size: 14px;
    color: var(--text-secondary);
}
.record-actions {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
}
.btn-delete {
    background: var(--danger-color);
    color: white;
    border: none;
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-md);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}
.btn-delete:hover {
    background: #dc2626;
    transform: scale(1.05);
}
.no-records {
    text-align: center;
    padding: var(--spacing-6xl) var(--spacing-3xl);
    color: var(--text-secondary);
}
.no-records-icon {
    font-size: 64px;
    margin-bottom: var(--spacing-lg);
    opacity: 0.3;
}
.no-records h3 {
    font-size: 20px;
    margin-bottom: var(--spacing-sm);
    color: var(--text-primary);
    font-weight: 600;
}
.no-records p {
    font-size: 16px;
    margin: 0;
}
.pet-changes-section {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin-bottom: var(--spacing-xl);
}
.pet-changes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--spacing-lg);
    padding: var(--spacing-xl);
}
.pet-change-card {
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-tertiary) 100%);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.pet-change-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--primary-color);
    opacity: 0.8;
}
.pet-change-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-color);
}
.pet-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-md);
}
.pet-name {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}
.pet-name i {
    color: var(--primary-color);
}
.last-measured {
    font-size: 12px;
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
}
.current-weight {
    text-align: center;
    margin-bottom: var(--spacing-md);
}
.weight-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: var(--spacing-xs);
}
.weight-label {
    font-size: 14px;
    color: var(--text-secondary);
}
.weight-changes {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}
.change-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--bg-primary);
    border-radius: var(--radius-md);
}
.change-period {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
}
.change-value {
    font-size: 14px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: var(--radius-sm);
}
.change-positive {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
}
.change-negative {
    background: rgba(34, 197, 94, 0.1);
    color: #16a34a;
}
.change-neutral {
    background: rgba(156, 163, 175, 0.1);
    color: #6b7280;
}
.no-pet-data {
    text-align: center;
    padding: var(--spacing-4xl);
    color: var(--text-secondary);
    grid-column: 1 / -1;
}
.no-pet-data i {
    font-size: 48px;
    margin-bottom: var(--spacing-lg);
    opacity: 0.3;
}
.trend-indicator {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-top: var(--spacing-sm);
    font-size: 12px;
    color: var(--text-secondary);
}
.trend-arrow {
    font-size: 14px;
}
.trend-up {
    color: #dc2626;
}
.trend-down {
    color: #16a34a;
}
.trend-stable {
    color: #6b7280;
}
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius-lg);
    color: white;
    font-weight: 500;
    box-shadow: var(--shadow-lg);
    z-index: 10000;
    max-width: 350px;
    transform: translateX(100%);
    transition: transform 0.3s ease;
}
.notification-success { background: var(--success-color); }
.notification-error { background: var(--danger-color); }
.notification-info { background: var(--primary-color); }
@media (max-width: 1024px) {
    .dashboard-grid { grid-template-columns: 1fr; }
    .stats-section { grid-template-columns: repeat(2, 1fr); }
    .pet-changes-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
}
@media (max-width: 768px) {
    .weight-nav { flex-direction: column; gap: var(--spacing-md); text-align: center; }
    .weight-title { font-size: 20px; }
    .weight-main { padding: var(--spacing-lg); }
    .stats-section { grid-template-columns: 1fr; }
    .pet-changes-grid { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }
    .records-grid { grid-template-columns: 1fr; }
    .section-header { flex-direction: column; gap: var(--spacing-md); align-items: stretch; }
    .section-filters { justify-content: center; }
    .nav-right { flex-direction: column; width: 100%; }
    .nav-btn { justify-content: center; }
}
</style>

<div class="weight-page">
    <div class="weight-header">
        <div class="weight-nav">
            <div class="nav-left">
                <button class="back-btn" onclick="history.back()">←</button>
                <h1 class="weight-title">
                    <i class="fas fa-weight" style="color: var(--color-primary);"></i>
                    체중관리
                </h1>
            </div>
            <div class="nav-right">
                <button class="nav-btn" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i>
                    새로고침
                </button>
                <button class="nav-btn" onclick="exportData()">
                    <i class="fas fa-download"></i>
                    데이터 내보내기
                </button>
            </div>
        </div>
    </div>

    <div class="weight-main">
        <!-- Pet-specific Changes Section -->
        <div class="pet-changes-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-paw"></i>
                    고양이별 최근 변화
                </h3>
            </div>
            <div class="pet-changes-grid" id="petChangesGrid">
                <!-- JavaScript로 동적 생성 -->
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Weight Record Form -->
            <div class="dashboard-card record-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-plus-circle"></i>
                        새 체중 기록
                    </h3>
                </div>
                <div class="card-content">
                    <form id="weightForm" class="weight-form">
                        <div class="form-group">
                            <label for="pet" class="form-label">
                                <i class="fas fa-paw"></i>
                                반려동물
                            </label>
                            <select class="form-input" id="pet" name="pet" required>
                                <option value="">선택해주세요</option>
                                <!-- JS에서 동적으로 옵션 추가 -->
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="date" class="form-label">
                                    <i class="fas fa-calendar-alt"></i>
                                    날짜
                                </label>
                                <input type="date" class="form-input" id="date" required>
                            </div>

                            <div class="form-group">
                                <label for="weight" class="form-label">
                                    <i class="fas fa-weight-hanging"></i>
                                    체중 (kg)
                                </label>
                                <input type="number" step="0.1" class="form-input" id="weight" placeholder="0.0" required>
                            </div>
                        </div>

                        <button type="submit" class="btn-submit">
                            <i class="fas fa-save"></i>
                            기록 저장
                        </button>
                    </form>
                </div>
            </div>

            <!-- Weight Chart -->
            <div class="dashboard-card chart-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-line"></i>
                        체중 변화 추이
                    </h3>
                    <div class="chart-controls">
                        <select id="chartPetFilter" class="chart-filter">
                            <option value="">전체 보기</option>
                            <!-- JS에서 동적으로 옵션 추가 -->
                        </select>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="weightChart"></canvas>
                    </div>
                    <div class="chart-legend" id="chartLegend">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Records Section -->
        <div class="records-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-history"></i>
                    체중 기록 목록
                </h3>
                <div class="section-filters">
                    <select id="petFilter" class="filter-select">
                        <option value="">전체 반려동물</option>
                        <!-- JS에서 동적으로 옵션 추가 -->
                    </select>
                    <div class="filter-info" id="filterInfo">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                </div>
            </div>

            <div class="records-container">
                <div class="records-grid" id="recordsGrid">
                    <!-- JavaScript로 동적 생성 -->
                </div>
                <div class="no-records" id="noRecords" style="display: none;">
                    <div class="no-records-icon">⚖️</div>
                    <h3>아직 체중 기록이 없어요</h3>
                    <p>첫 번째 체중 기록을 추가해보세요!</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
let weightChart = null; // 최상단 전역 선언
let allData = []; // 전역 변수로 선언

document.addEventListener('DOMContentLoaded', function() {
    // 반려동물 목록을 드롭다운에 추가
    const pets = JSON.parse('{{ user_pets|safe|escapejs }}');
    const petSelect = document.getElementById('pet');
    const petFilter = document.getElementById('petFilter');
    const chartPetFilter = document.getElementById('chartPetFilter');
    
    pets.forEach(function(pet) {
        // 폼 드롭다운
        const option1 = document.createElement('option');
        option1.value = pet.id;
        option1.textContent = pet.name;
        petSelect.appendChild(option1);
        
        // 필터 드롭다운
        const option2 = document.createElement('option');
        option2.value = pet.id;
        option2.textContent = pet.name;
        petFilter.appendChild(option2);
        
        // 차트 필터 드롭다운
        const option3 = document.createElement('option');
        option3.value = pet.id;
        option3.textContent = pet.name;
        chartPetFilter.appendChild(option3);
    });

    const weightForm = document.getElementById('weightForm');
    const ctx = document.getElementById('weightChart').getContext('2d');

    // 오늘 날짜를 기본값으로 설정
    document.getElementById('date').valueAsDate = new Date();

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function updateStatsSection(data) {
        const statsSection = document.getElementById('statsSection');
        
        if (data.length === 0) {
            statsSection.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-chart-bar"></i></div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">총 기록</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-paw"></i></div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">반려동물</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">관리 일수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-trending-up"></i></div>
                    <div class="stat-value">-</div>
                    <div class="stat-label">최근 변화</div>
                </div>
            `;
            return;
        }

        const totalRecords = data.length;
        const uniquePets = [...new Set(data.map(item => item.pet))].length;
        const latestRecord = data[0];
        const oldestRecord = data[data.length - 1];
        const daysSinceFirst = oldestRecord ? Math.floor((new Date() - new Date(oldestRecord.date)) / (1000 * 60 * 60 * 24)) : 0;
        
        let recentChange = '-';
        if (latestRecord && latestRecord.change !== null) {
            const change = latestRecord.change;
            recentChange = change > 0 ? `+${change.toFixed(1)}kg` : 
                          change < 0 ? `${change.toFixed(1)}kg` : '변화없음';
        }

        statsSection.innerHTML = `
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-chart-bar"></i></div>
                <div class="stat-value">${totalRecords}</div>
                <div class="stat-label">총 기록</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-paw"></i></div>
                <div class="stat-value">${uniquePets}</div>
                <div class="stat-label">반려동물</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
                <div class="stat-value">${daysSinceFirst}</div>
                <div class="stat-label">관리 일수</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-trending-up"></i></div>
                <div class="stat-value">${recentChange}</div>
                <div class="stat-label">최근 변화</div>
            </div>
        `;
    }

    function updatePetChangesSection(data) {
        const petChangesGrid = document.getElementById('petChangesGrid');
        
        if (data.length === 0) {
            petChangesGrid.innerHTML = `
                <div class="no-pet-data">
                    <i class="fas fa-paw"></i>
                    <h3>아직 체중 기록이 없어요</h3>
                    <p>첫 번째 체중 기록을 추가해보세요!</p>
                </div>
            `;
            return;
        }

        // 반려동물별로 데이터 그룹화
        const petData = {};
        data.forEach(item => {
            if (!petData[item.pet]) {
                petData[item.pet] = {
                    name: item.pet_name,
                    records: []
                };
            }
            petData[item.pet].records.push(item);
        });

        // 각 반려동물에 대한 변화 카드 생성
        let cardsHTML = '';
        Object.values(petData).forEach(pet => {
            const records = pet.records.sort((a, b) => new Date(b.date) - new Date(a.date));
            const latestRecord = records[0];
            
            if (!latestRecord) return;

            // 기간별 변화 계산
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            const weekRecords = records.filter(r => new Date(r.date) >= oneWeekAgo);
            const monthRecords = records.filter(r => new Date(r.date) >= oneMonthAgo);
            
            let weekChange = '-';
            let monthChange = '-';
            
            if (weekRecords.length >= 2) {
                const oldestWeek = weekRecords[weekRecords.length - 1];
                const weekDiff = latestRecord.weight - oldestWeek.weight;
                weekChange = formatChange(weekDiff);
            }
            
            if (monthRecords.length >= 2) {
                const oldestMonth = monthRecords[monthRecords.length - 1];
                const monthDiff = latestRecord.weight - oldestMonth.weight;
                monthChange = formatChange(monthDiff);
            }

            // 트렌드 계산 (최근 3개 기록 기준)
            let trend = 'stable';
            let trendIcon = '→';
            let trendClass = 'trend-stable';
            
            if (records.length >= 3) {
                const recent3 = records.slice(0, 3);
                const avgChange = (recent3[0].weight - recent3[2].weight) / 2;
                if (avgChange > 0.1) {
                    trend = 'up';
                    trendIcon = '↗';
                    trendClass = 'trend-up';
                } else if (avgChange < -0.1) {
                    trend = 'down';
                    trendIcon = '↘';
                    trendClass = 'trend-down';
                }
            }

            const daysSinceLastMeasure = Math.floor((now - new Date(latestRecord.date)) / (1000 * 60 * 60 * 24));
            const lastMeasuredText = daysSinceLastMeasure === 0 ? '오늘' : 
                                   daysSinceLastMeasure === 1 ? '어제' : 
                                   `${daysSinceLastMeasure}일 전`;

            cardsHTML += `
                <div class="pet-change-card">
                    <div class="pet-card-header">
                        <div class="pet-name">
                            <i class="fas fa-cat"></i>
                            ${pet.name}
                        </div>
                        <div class="last-measured">${lastMeasuredText}</div>
                    </div>
                    
                    <div class="current-weight">
                        <div class="weight-value">${latestRecord.weight.toFixed(1)}</div>
                        <div class="weight-label">현재 체중 (kg)</div>
                        <div class="trend-indicator">
                            <span class="trend-arrow ${trendClass}">${trendIcon}</span>
                            <span>최근 트렌드</span>
                        </div>
                    </div>
                    
                    <div class="weight-changes">
                        <div class="change-item">
                            <span class="change-period">지난주 대비</span>
                            <span class="change-value ${getChangeClass(weekChange)}">${weekChange}</span>
                        </div>
                        <div class="change-item">
                            <span class="change-period">지난달 대비</span>
                            <span class="change-value ${getChangeClass(monthChange)}">${monthChange}</span>
                        </div>
                        <div class="change-item">
                            <span class="change-period">총 기록 수</span>
                            <span class="change-value change-neutral">${records.length}개</span>
                        </div>
                    </div>
                </div>
            `;
        });

        petChangesGrid.innerHTML = cardsHTML;
    }

    function formatChange(change) {
        if (Math.abs(change) < 0.01) return '변화없음';
        return change > 0 ? `+${change.toFixed(1)}kg` : `${change.toFixed(1)}kg`;
    }

    function getChangeClass(changeText) {
        if (changeText === '-' || changeText === '변화없음') return 'change-neutral';
        if (changeText.startsWith('+')) return 'change-positive';
        if (changeText.startsWith('-')) return 'change-negative';
        return 'change-neutral';
    }

    function updateRecordsGrid(data) {
        const recordsGrid = document.getElementById('recordsGrid');
        const noRecords = document.getElementById('noRecords');
        const filterInfo = document.getElementById('filterInfo');
        
        if (data.length === 0) {
            recordsGrid.style.display = 'none';
            noRecords.style.display = 'block';
            filterInfo.textContent = '';
            return;
        }

        recordsGrid.style.display = 'grid';
        noRecords.style.display = 'none';
        
        const selectedPet = petFilter.value;
        let infoText = `총 ${data.length}개의 기록`;
        if (selectedPet) {
            const petName = pets.find(p => p.id == selectedPet)?.name;
            infoText = `${petName}: ${data.length}개의 기록`;
        }
        filterInfo.textContent = infoText;

        recordsGrid.innerHTML = '';
        data.forEach(item => {
            const recordItem = document.createElement('div');
            recordItem.className = 'record-item';

            let changeHTML = '';
            if (item.change !== null) {
                const change = item.change.toFixed(1);
                const changeClass = change > 0 ? 'change-positive' : 
                                 change < 0 ? 'change-negative' : 'change-neutral';
                const changeText = change > 0 ? `+${change}kg` : 
                                 change < 0 ? `${change}kg` : '변화없음';
                changeHTML = `<span class="change-value ${changeClass}">${changeText}</span>`;
            } else {
                changeHTML = `<span class="change-value change-neutral">첫 기록</span>`;
            }

            const daysSince = item.days_since_last ? `${item.days_since_last}일 전 측정` : '';

            recordItem.innerHTML = `
                <div class="record-header">
                    <div class="record-pet">
                        <i class="fas fa-paw"></i>
                        ${item.pet_name}
                    </div>
                    <div class="record-date">${formatDate(item.date)}</div>
                </div>
                <div class="record-weight">${item.weight.toFixed(1)}kg</div>
                <div class="record-change">
                    ${changeHTML}
                    <div class="days-since">${daysSince}</div>
                </div>
                <div class="record-actions">
                    <button class="btn-delete" onclick="deleteRecord(${item.id})">
                        <i class="fas fa-trash"></i>
                        삭제
                    </button>
                </div>
            `;

            recordsGrid.appendChild(recordItem);
        });
    }

    function updateChart(data) {
        const selectedPet = chartPetFilter.value;
        let filtered = data;
        
        if (selectedPet) {
            filtered = data.filter(item => String(item.pet) === selectedPet);
        }

        // 반려동물별로 데이터 그룹화
        const petData = {};
        filtered.forEach(item => {
            if (!petData[item.pet]) {
                petData[item.pet] = {
                    name: item.pet_name,
                    data: []
                };
            }
            petData[item.pet].data.push(item);
        });

        // 차트용 데이터셋 생성
        const datasets = [];
        const colors = ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#06B6D4', '#84CC16'];
        let colorIndex = 0;

        Object.values(petData).forEach(pet => {
            const sortedData = pet.data.sort((a, b) => new Date(a.date) - new Date(b.date));
            datasets.push({
                label: pet.name,
                data: sortedData.map(item => ({
                    x: item.date,
                    y: item.weight
                })),
                borderColor: colors[colorIndex % colors.length],
                backgroundColor: colors[colorIndex % colors.length] + '20',
                tension: 0.3,
                fill: false,
                pointRadius: 6,
                pointHoverRadius: 8,
                borderWidth: 3
            });
            colorIndex++;
        });

        if (weightChart) {
            weightChart.destroy();
            weightChart = null;
        }

        weightChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        cornerRadius: 8,
                        callbacks: {
                            title: function(context) {
                                return formatDate(context[0].parsed.x);
                            },
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}kg`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MM/dd' // 소문자 dd로 수정
                            }
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + 'kg';
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });

        // 범례 업데이트
        updateChartLegend(datasets);
    }

    function updateChartLegend(datasets) {
        const chartLegend = document.getElementById('chartLegend');
        chartLegend.innerHTML = '';
        
        datasets.forEach(dataset => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.innerHTML = `
                <div class="legend-color" style="background-color: ${dataset.borderColor}"></div>
                <span>${dataset.label}</span>
            `;
            chartLegend.appendChild(legendItem);
        });
    }

    // 데이터 로드 및 초기화
    function loadData() {
        fetch('/weight/api/weights/')
            .then(response => response.json())
            .then(data => {
                allData = data;
                updatePetChangesSection(data);
                updateChart(data);
                filterAndRenderRecords();
            })
            .catch(error => {
                console.error('데이터 로드 중 오류:', error);
            });
    }

    function filterAndRenderRecords() {
        const selectedPet = petFilter.value;
        let filtered = allData;
        
        if (selectedPet) {
            filtered = allData.filter(item => String(item.pet) === selectedPet);
        }
        
        updateRecordsGrid(filtered);
    }

    // 이벤트 리스너
    petFilter.addEventListener('change', filterAndRenderRecords);
    chartPetFilter.addEventListener('change', () => updateChart(allData));

    // 체중 기록 제출
    weightForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = this.querySelector('.btn-submit');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 저장 중...';
        submitBtn.disabled = true;
        
        const data = {
            date: document.getElementById('date').value,
            weight: parseFloat(document.getElementById('weight').value),
            pet: parseInt(document.getElementById('pet').value)
        };
        
        fetch('/weight/api/weights/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json().then(json => ({status: response.status, body: json})))
        .then(result => {
            if (result.status === 201 && result.body.id) {
                weightForm.reset();
                document.getElementById('date').valueAsDate = new Date();
                loadData();
                
                // 성공 메시지
                showNotification('체중 기록이 성공적으로 저장되었습니다!', 'success');
            } else if (result.status === 400 && result.body && result.body.error) {
                showNotification(result.body.error, 'error');
            } else {
                showNotification('저장 중 오류가 발생했습니다.', 'error');
            }
        })
        .catch(error => {
            console.error('저장 중 오류:', error);
            showNotification('저장 중 오류가 발생했습니다.', 'error');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });

    // 초기 데이터 로드
    loadData();

    // 기본 필터 설정
    if (pets.length > 0) {
        chartPetFilter.value = pets[0].id;
        updateChart(allData);
    }
});

// 기록 삭제
function deleteRecord(recordId) {
    if (!confirm('정말 이 기록을 삭제하시겠습니까?')) {
        return;
    }
    
    fetch(`/weight/api/weights/${recordId}/`, {
        method: 'DELETE',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
    })
    .then(response => {
        if (response.ok) {
            showNotification('기록이 삭제되었습니다.', 'success');
            // 데이터 다시 로드
            fetch('/weight/api/weights/')
                .then(response => response.json())
                .then(data => {
                    allData = data;
                    updatePetChangesSection(data);
                    updateChart(data);
                    filterAndRenderRecords();
                });
        } else {
            showNotification('삭제 중 오류가 발생했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('삭제 중 오류:', error);
        showNotification('삭제 중 오류가 발생했습니다.', 'error');
    });
}

// 데이터 내보내기
function exportData() {
    if (allData.length === 0) {
        showNotification('내보낼 데이터가 없습니다.', 'info');
        return;
    }
    
    // CSV 형태로 데이터 내보내기
    const csv = [
        ['날짜', '반려동물', '체중(kg)', '변화량(kg)'],
        ...allData.map(item => [
            item.date, 
            item.pet_name, 
            item.weight.toFixed(1), 
            item.change ? item.change.toFixed(1) : ''
        ])
    ].map(row => row.join(',')).join('\n');
    
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `체중기록_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showNotification('데이터가 내보내기되었습니다.', 'success');
}

// 알림 메시지 표시
function showNotification(message, type = 'info') {
    // 기존 알림 제거
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // 애니메이션
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // 자동 제거
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 